---
import Layout from '../layouts/Layout.astro';
import AffiliateLink from '../components/AffiliateLink.astro';
import { fetchPosts, formatDate, tagToLabel, paginate } from '../lib/posts';

// Get all posts and sort them by date
const allPosts = await fetchPosts();
const pageParam = Number(Astro.url.searchParams.get('page') || '1');
const { slice, currentPage, totalPages } = paginate(allPosts, pageParam);
---

<Layout title="CoursesWyn · Best Course Reviews 2026" description="Independent reviews covering the best Udemy courses for AI, coding, and automation—ranked with real outcomes and affiliate transparency.">
  <!-- Your existing header and featured posts section -->

  <!-- Latest Drops Section -->
  <section class="space-y-8">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-semibold text-white">Latest Drops</h2>
      <a class="text-sm text-white/60 hover:text-white" href="/rss.xml">RSS feed</a>
    </div>
    <div class="grid gap-6 md:grid-cols-2">
      {slice.map((post) => (
        <article class="rounded-3xl border border-white/5 bg-surface/70 p-6 backdrop-blur">
          <div class="flex items-center justify-between text-sm text-white/50">
            <span>{formatDate(post.data.pubDate)}</span>
            <span>{post.data.tags.map((tag) => tagToLabel(tag)).join(' · ')}</span>
          </div>
          <h3 class="mt-4 text-xl font-semibold text-white">
            <a href={`/${post.slug}/`} class="hover:text-mint-300">{post.data.title}</a>
          </h3>
          <p class="mt-2 text-white/70">{post.data.description}</p>
          <div class="mt-6 flex gap-3 text-sm">
            <a class="text-mint-400 hover:text-mint-300" href={`/${post.slug}/`}>Read review →</a>
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- Pagination Controls -->
  {totalPages > 1 && (
    <div class="mt-8 flex justify-center gap-4">
      {currentPage > 1 && (
        <a href={currentPage > 2 ? `/?page=${currentPage - 1}` : '/'} class="px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5 transition-colors">
          ← Previous
        </a>
      )}
      <span class="px-4 py-2 text-white/60">
        Page {currentPage} of {totalPages}
      </span>
      {currentPage < totalPages && (
        <a href={`/?page=${currentPage + 1}`} class="px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5 transition-colors">
          Next →
        </a>
      )}
    </div>
  )}
</Layout>