---
import Layout from '../../../layouts/Layout.astro';
import BlogCard from '../../../components/blog/BlogCard.astro';
import { fetchPosts, formatDate, paginate, tagToLabel } from '../../../lib/posts';
import Search from '../../../components/Search.astro';

export async function getStaticPaths() {
  const posts = await fetchPosts();
  const { totalPages } = paginate(posts, 1);
  
  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}

const posts = await fetchPosts();
const currentPageNum = Number(Astro.params.page);
const { slice, currentPage, totalPages } = paginate(posts, currentPageNum);

const baseUrl = '/blog/';
const pageHref = (page: number) => (page <= 1 ? baseUrl : `${baseUrl}page/${page}/`);
const currentUrl = currentPage === 1 ? baseUrl : `${baseUrl}page/${currentPage}/`;
const canonicalUrl = currentPage === 1 ? baseUrl : `${baseUrl}page/${currentPage}/`;
const nextPageUrl = currentPage < totalPages ? pageHref(currentPage + 1) : undefined;
const prevPageUrl = currentPage > 1 ? pageHref(currentPage - 1) : undefined;

const title = `Course Reviews & Learning Guides (Page ${currentPage}) - CoursesWyn`;
const description = `In-depth, independent reviews of the best Udemy courses. Page ${currentPage} of our AI, Python, Web Development, Data Science, and 50+ other course categories.`;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": title,
  "description": description,
  "url": `https://courseswyn.com${canonicalUrl}`,
  "mainEntity": {
    "@type": "Blog",
    "headline": "Course Reviews & Learning Guides",
    "description": description,
    "blogPost": slice.map((post) => ({
      "@type": "BlogPosting",
      "headline": post.data.title,
      "description": post.data.description,
      "url": `https://courseswyn.com/${post.slug}/`,
      "datePublished": post.data.pubDate.toISOString(),
      "author": {
        "@type": "Organization",
        "name": "CoursesWyn"
      },
      "image": post.data.image?.src || 'https://courseswyn.com/images/og-default.svg'
    }))
  }
};
---

<Layout 
  title={currentPage === 1 ? "Course Reviews & Learning Guides - CoursesWyn" : title} 
  description={description} 
  canonical={`https://courseswyn.com${canonicalUrl}`}
  structuredData={structuredData}
  paginationNext={nextPageUrl ? `https://courseswyn.com${nextPageUrl}` : undefined}
  paginationPrev={prevPageUrl ? `https://courseswyn.com${prevPageUrl}` : undefined}
>
  <section class="mb-12 space-y-4">
    <div class="flex items-center gap-3 mb-8">
      <div class="w-1 h-10 bg-gradient-to-b from-indigo-500 to-purple-500 rounded-full"></div>
      <h1 class="text-4xl md:text-5xl font-black bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">Course Reviews & Learning Guides</h1>
    </div>
    <p class="text-white/70 max-w-2xl text-lg leading-relaxed">
      In-depth, independent reviews of the best Udemy courses. Find expert recommendations for AI, Python, Web Development, Data Science, and 50+ other categories.
    </p>
  </section>

  <Search posts={posts} />

  <section class="deals-grid my-12">
    {slice.map((post) => (
      <BlogCard
        title={post.data.title}
        description={post.data.description}
        slug={post.slug}
        pubDate={post.data.pubDate}
        tags={post.data.tags}
        image={post.data.image}
      />
    ))}
  </section>

  {totalPages > 1 && (
    <nav class="mt-12 flex items-center justify-between gap-4 flex-wrap">
      <a
        class:list={{
          'px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-indigo-500 to-purple-600 text-white hover:shadow-lg hover:shadow-indigo-500/50': currentPage > 1,
          'px-6 py-3 rounded-lg font-semibold text-white/30 pointer-events-none': currentPage === 1,
        }}
        href={pageHref(currentPage - 1)}
      >
        ← Newer posts
      </a>
      <span class="text-white/70 font-semibold">
        Page {currentPage} of {totalPages}
      </span>
      <a
        class:list={{
          'px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:shadow-lg hover:shadow-purple-500/50': currentPage < totalPages,
          'px-6 py-3 rounded-lg font-semibold text-white/30 pointer-events-none': currentPage === totalPages,
        }}
        href={pageHref(currentPage + 1)}
      >
        Older posts →
      </a>
    </nav>
  )}
</Layout>
