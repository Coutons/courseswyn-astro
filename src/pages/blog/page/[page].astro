---
import Layout from '../../../layouts/Layout.astro';
import BlogCard from '../../../components/blog/BlogCard.astro';
import { fetchPosts, formatDate, paginate, tagToLabel } from '../../../lib/posts';
import Search from '../../../components/Search.astro';

export async function getStaticPaths() {
  const posts = await fetchPosts();
  const { totalPages } = paginate(posts, 1);
  
  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}

const posts = await fetchPosts();
const currentPageNum = Number(Astro.params.page);
const { slice, currentPage, totalPages } = paginate(posts, currentPageNum);

const baseUrl = '/blog/';
const pageHref = (page: number) => (page <= 1 ? baseUrl : `${baseUrl}page/${page}/`);
const currentUrl = currentPage === 1 ? baseUrl : `${baseUrl}page/${currentPage}/`;
const canonicalUrl = currentPage === 1 ? baseUrl : `${baseUrl}page/${currentPage}/`;
const nextPageUrl = currentPage < totalPages ? pageHref(currentPage + 1) : undefined;
const prevPageUrl = currentPage > 1 ? pageHref(currentPage - 1) : undefined;

const title = `Udemy Course Reviews & Learning Guides (Page ${currentPage}) - CoursesWyn`;
const description = `In-depth, independent reviews of the best Udemy courses. Page ${currentPage} of our AI, Python, Web Development, Data Science, and 50+ other course categories.`;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": title,
  "description": description,
  "url": `https://courseswyn.com${canonicalUrl}`,
  "mainEntity": {
    "@type": "Blog",
    "headline": "Udemy Course Reviews & Learning Guides",
    "description": description,
    "blogPost": slice.map((post) => ({
      "@type": "BlogPosting",
      "headline": post.data.title,
      "description": post.data.description,
      "url": `https://courseswyn.com/${post.slug}/`,
      "datePublished": post.data.pubDate.toISOString(),
      "author": {
        "@type": "Organization",
        "name": "CoursesWyn"
      },
      "image": post.data.image?.src || 'https://courseswyn.com/images/og-default.svg'
    }))
  }
};
---

<Layout
  title={currentPage === 1 ? "Udemy Course Reviews & Learning Guides - CoursesWyn" : title}
  description={description}
  canonical={`https://courseswyn.com${canonicalUrl}`}
  structuredData={structuredData}
  paginationNext={nextPageUrl ? `https://courseswyn.com${nextPageUrl}` : undefined}
  paginationPrev={prevPageUrl ? `https://courseswyn.com${prevPageUrl}` : undefined}
>
  <!-- Breadcrumb Navigation for SEO -->
  <nav class="mb-6 text-sm text-slate-300" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2">
      <li><a href="/" class="hover:text-blue-400 transition-colors">Home</a></li>
      <li class="flex items-center">
        <svg class="w-4 h-4 mx-2 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
        </svg>
        <a href="/blog/" class="hover:text-blue-400 transition-colors">Blog</a>
      </li>
      {currentPage > 1 && (
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
          </svg>
          <span class="text-blue-400 font-medium">Page {currentPage}</span>
        </li>
      )}
    </ol>
  </nav>

  <header class="mb-8">
    <h1 class="text-4xl font-bold text-slate-100 mb-4">Udemy Course Reviews & Learning Guides</h1>
    <p class="text-lg text-slate-400 mb-4">In-depth, independent reviews of the best Udemy courses. Find expert recommendations for AI, Python, Web Development, Data Science, and 50+ other categories.</p>
  </header>

  <Search posts={posts} />

  <!-- Blog Grid -->
  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 my-12">
    {slice.map((post) => (
      <BlogCard
        title={post.data.title}
        description={post.data.description}
        slug={post.slug}
        pubDate={post.data.pubDate}
        tags={post.data.tags}
        image={post.data.image}
      />
    ))}
  </section>

  <!-- Pagination -->
  {totalPages > 1 && (
    <div class="mt-8 flex justify-center">
      <nav class="flex space-x-2" aria-label="Pagination">
        {currentPage > 1 && (
          <a
            href={pageHref(currentPage - 1)}
            class="px-3 py-2 border border-slate-700 rounded hover:bg-slate-800/50 hover:border-blue-500/50 text-slate-300 transition-colors"
          >
            Previous
          </a>
        )}

        {Array.from({ length: totalPages }, (_, i) => i + 1).map(pageNum => (
          <a
            href={pageHref(pageNum)}
            class={`px-3 py-2 border rounded transition-colors ${
              pageNum === currentPage
                ? 'bg-gradient-to-r from-blue-600 to-blue-500 text-white border-blue-600'
                : 'border-slate-700 hover:bg-slate-800/50 hover:border-blue-500/50 text-slate-300'
            }`}
          >
            {pageNum}
          </a>
        ))}

        {currentPage < totalPages && (
          <a
            href={pageHref(currentPage + 1)}
            class="px-3 py-2 border border-slate-700 rounded hover:bg-slate-800/50 hover:border-blue-500/50 text-slate-300 transition-colors"
          >
            Next
          </a>
        )}
      </nav>

      <p class="ml-4 text-sm text-slate-400 self-center">
        Page {currentPage} of {totalPages}
      </p>
    </div>
  )}
</Layout>
