---
import MainLayout from '../../../../layouts/MainLayout.astro';
import coupons from '../../../../data/coupons.json';
import CourseCard from '../../../../components/CourseCard.astro';

export async function getStaticPaths({ paginate }: { paginate: any }) {
  const subcategories = [...new Set(coupons.map(c => c.subcategory).filter(Boolean))];
  
  return subcategories.flatMap(subcategory => {
    const filteredCourses = coupons.filter(c => c.subcategory === subcategory);
    filteredCourses.sort((a, b) => new Date(b.updatedAt || new Date()).getTime() - new Date(a.updatedAt || new Date()).getTime());
    
    return paginate(filteredCourses, {
      params: { subcategory: subcategory?.toLowerCase().replace(/\s+/g, '-') },
      props: { originalSubcategory: subcategory },
      pageSize: 16
    });
  });
}

const { page, originalSubcategory } = Astro.props;
const { subcategory } = Astro.params;
const allCourses = page.data;
const pageTitle = `Free ${originalSubcategory} Courses - Coupon Codes${page.currentPage > 1 ? ` - Page ${page.currentPage}` : ''}`;
const pageDescription = `Get the best ${originalSubcategory} courses for free or 90% off. Verified Udemy coupons for ${originalSubcategory}, programming, and design. Start learning ${originalSubcategory} today.`;

// SEO & Schema
const schemaData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": pageTitle,
  "description": pageDescription,
  "url": Astro.url.href,
  "mainEntity": {
     "@type": "ItemList",
     "itemListElement": allCourses.map((course: any, index: number) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `https://courseswyn.com/coupon/${course.slug}`,
      "name": course.title
    }))
  }
};
---

<MainLayout title={pageTitle} description={pageDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  
  <div class="bg-[#1a1d29] min-h-screen pb-20">
    
    <!-- Header Section -->
    <div class="bg-[#1c252e] pt-8 pb-4 relative z-30">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
         <!-- Top Tabs -->
         <div class="flex justify-center mb-8">
            <div class="flex items-center bg-[#242938] rounded-xl p-1 gap-1 border border-[#2d3748]">
                <a href="/topics" class="flex items-center gap-2 px-6 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-[#1a1d29] transition-all text-sm font-medium">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                   My Interests
                </a>
                <a href="/udemy-coupon-code" class="flex items-center gap-2 px-6 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-[#1a1d29] transition-all text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    All Courses
                 </a>
                <div class="flex items-center gap-2 px-6 py-2 rounded-lg bg-[#1a1d29] text-[#10b981] shadow-lg text-sm font-bold border border-[#2d3748]">
                    {originalSubcategory}
                </div>
            </div>
         </div>

         <!-- Controls Row (Search Left, Sort Right) -->
         <div class="flex flex-col md:flex-row items-center justify-between gap-4">
              
              <!-- Search Bar -->
              <div class="relative w-full md:w-96 group">
                 <form action="/search" method="GET">
                     <input 
                     type="text" 
                     name="q"
                     placeholder={`Search in ${originalSubcategory}...`}
                     class="w-full bg-[#1c252e] border border-[#2d3748] rounded-lg px-4 py-2.5 text-white placeholder-gray-400 focus:outline-none focus:border-green-500 transition-all font-sans text-sm shadow-inner" 
                     />
                     <button type="submit" class="absolute right-3 top-2.5 text-[#10b981] hover:text-green-400 transition-colors bg-transparent border-none p-0 cursor-pointer">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                     </button>
                 </form>
              </div>

              <!-- Filter Info -->
              <div class="flex items-center gap-4">
                 <div class="flex items-center gap-3">
                    <span class="text-white font-bold text-sm bg-transparent">
                       {page.total} Courses found
                    </span>
                 </div>
              </div>
          </div>

      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
      
      <!-- Course Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {allCourses.map((course: any) => (
           <CourseCard course={course} />
        ))}
      </div>

      <!-- Pagination -->
      {page.lastPage > 1 && (
      <div class="flex justify-center mt-12 mb-20">
        <div class="flex items-center gap-2 bg-[#242938] p-2 rounded-xl border border-[#2d3748]">
             {page.url.prev ? (
                <a href={page.url.prev} class="px-4 h-10 flex items-center gap-2 rounded-lg text-gray-400 hover:text-white hover:bg-[#1a1d29] transition-all text-sm font-bold">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    Prev
                </a>
            ) : null}

             <span class="px-4 py-2 font-bold text-[#10b981] bg-[#1a1d29] rounded-lg border border-[#2d3748] text-sm">
                Page {page.currentPage} of {page.lastPage}
             </span>

            {page.url.next ? (
                <a href={page.url.next} class="px-4 h-10 flex items-center gap-2 rounded-lg text-gray-400 hover:text-white hover:bg-[#1a1d29] transition-all text-sm font-bold">
                    Next
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7-7"/></svg>
                </a>
            ) : null}
        </div>
      </div>
      )}

    </div>
  </div>
</MainLayout>
