---
import type { Course } from '../../lib/courses';
import { getAllCourses } from '../../lib/courses';
import MainLayout from '../../layouts/MainLayout.astro';
import CourseDetailSchema from '../../components/CourseDetailSchema.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import TrustSignals from '../../components/TrustSignals.astro';
import ExpiryDisplay from '../../components/ExpiryDisplay.astro';
import DifferentiationLayer from '../../components/DifferentiationLayer.astro';
import InternalLinkingOptimization from '../../components/InternalLinkingOptimization.astro';

export async function getStaticPaths() {
  const courses = await getAllCourses();
  return courses.map((course: Course) => ({
    params: { slug: course.slug },
    props: { course },
  }));
}

const { course } = Astro.props as { course: Course };

const title = `${course.title} Free Coupon 2025 - ${course.category} Course Deal | CoursesWyn`;
const description = `${course.title} 100% off coupon. ${course.description}. Limited time offer by ${course.instructor}. Verified ${course.lastVerified}.`;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Course',
  name: course.title,
  description: course.description,
  provider: {
    '@type': 'EducationalOrganization',
    name: 'Udemy',
    url: 'https://www.udemy.com',
  },
  instructor: {
    '@type': 'Person',
    name: course.instructor,
  },
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD',
    availability:
      new Date(course.expiresAt) > new Date()
        ? 'https://schema.org/InStock'
        : 'https://schema.org/OutOfStock',
    validFrom: course.lastVerified,
    validThrough: course.expiresAt,
    url: course.affiliateLink,
    seller: {
      '@type': 'Organization',
      name: 'Udemy',
    },
  },
  aggregateRating: {
    '@type': 'AggregateRating',
    ratingValue: course.rating,
    reviewCount: course.students,
    bestRating: 5,
    worstRating: 1,
  },
  educationalLevel: course.level,
  timeRequired: `PT${course.duration}H`,
  about: course.category,
  image: course.imageUrl,
  dateModified: new Date().toISOString(),
};
---

<MainLayout
  title={title}
  description={description}
  canonical={`https://courseswyn.com/courses/${course.slug}/`}
  ogImage={course.imageUrl}
  structuredData={structuredData}
>
  <CourseDetailSchema course={course} />

  <!-- Background Accents (match coupon detail style) -->
  <div class="fixed inset-0 bg-slate-950"></div>
  <div class="fixed inset-0 bg-[radial-gradient(1100px_circle_at_20%_0%,rgba(34,197,94,0.08),transparent_55%)] pointer-events-none"></div>
  <div class="fixed inset-0 bg-[radial-gradient(900px_circle_at_80%_10%,rgba(56,189,248,0.06),transparent_55%)] pointer-events-none"></div>

  <div class="relative z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
      <div class="mb-6 opacity-70 hover:opacity-100 transition-opacity">
        <Breadcrumb courseTitle={course.title} />
      </div>
    </div>

    <!-- Udemy-like Hero (left details, right preview/enroll) -->
    <section class="bg-slate-950 border-y border-slate-800/70">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-start">
          <div class="lg:col-span-8">
            <div class="flex flex-wrap items-center gap-2 mb-4">
              <span class="inline-flex items-center gap-2 bg-primary/10 text-primary text-[11px] font-black px-3 py-1.5 rounded-full border border-primary/20 uppercase tracking-wider">
                <span class="w-2 h-2 bg-primary rounded-full"></span>
                {course.category}
              </span>
              <span class="inline-flex items-center gap-2 bg-slate-900/50 text-slate-200 text-[11px] font-black px-3 py-1.5 rounded-full border border-slate-800/70 uppercase tracking-wider">
                {course.level}
              </span>
              <span class="inline-flex items-center gap-2 bg-red-500/10 text-red-200 text-[11px] font-black px-3 py-1.5 rounded-full border border-red-500/20 uppercase tracking-wider">
                {course.discount}
              </span>
            </div>

            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black tracking-tight leading-[1.08] text-white">
              {course.title}
            </h1>

            <p class="mt-3 text-slate-300 text-base sm:text-lg leading-relaxed">
              {course.description}
            </p>

            <div class="mt-5 flex flex-wrap items-center gap-3 text-sm">
              <div class="inline-flex items-center gap-2 text-slate-200">
                <span class="text-yellow-300 font-black">★ {course.rating}</span>
                <span class="text-slate-400">Based on {course.students.toLocaleString()} Udemy students</span>
              </div>
              <span class="text-slate-600">|</span>
              <span class="text-slate-300">Created by <span class="text-white font-bold">{course.instructor}</span></span>
              <span class="text-slate-600">|</span>
              <span class="text-slate-400">Verified {course.lastVerified}</span>
            </div>

            <div class="mt-6">
              <TrustSignals course={course} />
            </div>
          </div>

          <div class="lg:col-span-4">
            <div class="lg:sticky lg:top-6">
              <div class="bg-slate-900/40 border border-slate-800/70 rounded-[1.75rem] overflow-hidden backdrop-blur-xl shadow-2xl">
                <div class="p-4">
                  <div class="relative aspect-video rounded-2xl overflow-hidden border border-slate-800/70">
                    <img src={course.imageUrl} alt={course.title} class="w-full h-full object-cover" loading="lazy" />
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-950/70 via-slate-950/25 to-transparent"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <div class="w-14 h-14 rounded-full bg-slate-950/70 border border-slate-800/70 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" class="text-white">
                          <path d="M8 5v14l11-7z"></path>
                        </svg>
                      </div>
                    </div>
                    <div class="absolute bottom-3 left-3">
                      <span class="text-[10px] font-black uppercase tracking-widest bg-slate-950/70 border border-slate-800/70 text-slate-200 px-3 py-1 rounded-full">
                        Preview
                      </span>
                    </div>
                  </div>
                </div>

                <div class="p-6 pt-2">
                  <div class="flex items-end justify-between gap-4">
                    <div>
                      <div class="text-4xl font-black text-white leading-none">FREE</div>
                      <div class="mt-1 text-sm text-slate-400 line-through font-bold">{course.originalPrice}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-[11px] uppercase tracking-[0.22em] text-slate-400 font-black">This course includes</div>
                      <div class="mt-2 text-xs text-slate-300">{course.duration} hours on-demand video</div>
                      <div class="text-xs text-slate-300">{course.resources} resources</div>
                    </div>
                  </div>

                  <a
                    href={course.affiliateLink}
                    target="_blank"
                    rel="nofollow noopener noreferrer"
                    class="mt-5 block w-full bg-primary hover:bg-primary/90 text-primary-foreground font-black py-4 px-6 rounded-2xl text-center shadow-xl shadow-primary/20"
                    onclick="trackEnrollClick()"
                  >
                    Enroll Free Now
                  </a>

                  <div class="mt-5">
                    <div class="coupon-container group cursor-pointer" data-coupon-reveal data-code={course.couponCode}>
                      <div class="text-center text-[10px] text-slate-400 font-black uppercase tracking-widest mb-3 italic">Reveal & Copy Coupon Code</div>
                      <div class="relative bg-slate-950/70 border-2 border-dashed border-slate-700/60 group-hover:border-primary/55 rounded-2xl py-4 flex flex-col items-center gap-1 transition-all">
                        <span class="coupon-text filter blur-[4px] select-none text-2xl font-black text-slate-400 group-hover:text-slate-300">XXXXXXXX</span>
                        <div class="absolute inset-0 flex items-center justify-center opacity-100 group-hover:opacity-0 transition-opacity">
                          <span class="bg-primary text-primary-foreground text-[10px] font-black px-4 py-1.5 rounded-full shadow-lg">CLICK TO SHOW</span>
                        </div>
                        <p class="text-[10px] items-center gap-1 text-primary font-bold feedback-text flex">
                          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-bounce"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                          REVEAL & COPY
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="mt-5">
                    <ExpiryDisplay course={course} />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sticky Udemy-like tabs -->
    <div class="sticky top-0 z-40 bg-slate-950/90 backdrop-blur-xl border-b border-slate-800/70">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="flex gap-6 overflow-x-auto py-3 text-sm font-bold text-slate-300">
          <a href="#overview" class="whitespace-nowrap hover:text-white">Overview</a>
          <a href="#learn" class="whitespace-nowrap hover:text-white">What you’ll learn</a>
          <a href="#audience" class="whitespace-nowrap hover:text-white">Who it’s for</a>
          <a href="#review" class="whitespace-nowrap hover:text-white">Honest review</a>
          <a href="#analysis" class="whitespace-nowrap hover:text-white">2025 fit</a>
          <a href="#faq" class="whitespace-nowrap hover:text-white">FAQ</a>
        </nav>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
        <div class="lg:col-span-8 space-y-10">
          <section id="overview" class="bg-slate-900/30 border border-slate-800/70 rounded-[1.75rem] p-6 sm:p-10 backdrop-blur-xl">
            <h2 class="text-2xl font-black text-white">Overview</h2>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div class="bg-slate-950/40 border border-slate-800/70 rounded-2xl p-5">
                <div class="text-[10px] uppercase tracking-[0.22em] text-slate-400 font-black">Category</div>
                <div class="mt-1 text-slate-100 font-black">{course.category}</div>
              </div>
              <div class="bg-slate-950/40 border border-slate-800/70 rounded-2xl p-5">
                <div class="text-[10px] uppercase tracking-[0.22em] text-slate-400 font-black">Level</div>
                <div class="mt-1 text-slate-100 font-black">{course.level}</div>
              </div>
              <div class="bg-slate-950/40 border border-slate-800/70 rounded-2xl p-5">
                <div class="text-[10px] uppercase tracking-[0.22em] text-slate-400 font-black">Resources</div>
                <div class="mt-1 text-slate-100 font-black">{course.resources}</div>
              </div>
            </div>
          </section>

          <section id="learn" class="bg-slate-900/30 border border-slate-800/70 rounded-[1.75rem] p-6 sm:p-10 backdrop-blur-xl">
            <h2 class="text-2xl font-black text-white">What you’ll learn</h2>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
              {course.learningOutcomes.map((item: string) => (
                <div class="flex gap-3 items-start bg-slate-950/40 border border-slate-800/70 rounded-2xl p-5">
                  <div class="w-9 h-9 rounded-xl bg-primary/15 border border-primary/25 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <div class="text-slate-200 font-bold text-sm leading-relaxed">{item}</div>
                </div>
              ))}
            </div>
          </section>

          <section id="audience" class="bg-slate-900/30 border border-slate-800/70 rounded-[1.75rem] p-6 sm:p-10 backdrop-blur-xl">
            <h2 class="text-2xl font-black text-white">Who this course is for</h2>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
              {course.targetAudience.map((aud: Course['targetAudience'][number]) => (
                <div class="bg-slate-950/40 border border-slate-800/70 rounded-2xl p-5">
                  <div class="flex gap-4 items-start">
                    <div class="w-11 h-11 rounded-2xl bg-slate-900/50 border border-slate-800/70 flex items-center justify-center flex-shrink-0 text-lg">
                      {aud.icon}
                    </div>
                    <div>
                      <div class="text-white font-black">{aud.title}</div>
                      <div class="mt-1 text-slate-400 text-sm leading-relaxed">{aud.description}</div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </section>

          <section id="review" class="bg-slate-900/30 border border-slate-800/70 rounded-[1.75rem] p-6 sm:p-10 backdrop-blur-xl">
            <h2 class="text-2xl font-black text-white">Honest review</h2>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-slate-950/40 border border-slate-800/70 rounded-2xl p-6">
                <div class="text-white font-black mb-4">Pros</div>
                <ul class="space-y-3">
                  {course.pros.map((pro: string) => (
                    <li class="text-slate-300 text-sm leading-relaxed">{pro}</li>
                  ))}
                </ul>
              </div>
              <div class="bg-slate-950/40 border border-slate-800/70 rounded-2xl p-6">
                <div class="text-white font-black mb-4">Cons</div>
                <ul class="space-y-3">
                  {course.cons.map((con: string) => (
                    <li class="text-slate-300 text-sm leading-relaxed">{con}</li>
                  ))}
                </ul>
              </div>
            </div>
          </section>

          <section id="analysis" class="space-y-10">
            <DifferentiationLayer course={course} />
            <InternalLinkingOptimization course={course} />
          </section>

          <section id="faq" class="bg-slate-900/30 border border-slate-800/70 rounded-[1.75rem] p-6 sm:p-10 backdrop-blur-xl">
            <h2 class="text-2xl font-black text-white">FAQ</h2>
            <div class="mt-6 space-y-4">
              {course.faqs.map((faq: Course['faqs'][number]) => (
                <details class="group bg-slate-950/40 border border-slate-800/70 rounded-2xl overflow-hidden transition-colors hover:border-primary/35">
                  <summary class="flex justify-between items-center p-5 cursor-pointer list-none">
                    <span class="text-sm font-black text-white group-open:text-primary transition-colors">{faq.question}</span>
                    <div class="w-8 h-8 rounded-xl bg-slate-900/60 border border-slate-800/70 flex items-center justify-center group-open:rotate-180 transition-transform">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                  </summary>
                  <div class="px-5 pb-5 text-sm text-slate-400 leading-relaxed border-t border-slate-800/70 pt-4">
                    {faq.answer}
                  </div>
                </details>
              ))}
            </div>
          </section>
        </div>

        <div class="lg:col-span-4">
          <div class="hidden lg:block sticky top-[88px]">
            <div class="bg-slate-900/30 border border-slate-800/70 rounded-[1.75rem] p-6 backdrop-blur-xl">
              <div class="text-[11px] uppercase tracking-[0.22em] text-slate-400 font-black">Enroll</div>
              <div class="mt-2 flex items-end justify-between">
                <div class="text-3xl font-black text-white">FREE</div>
                <div class="text-sm text-slate-400 line-through font-bold">{course.originalPrice}</div>
              </div>
              <a
                href={course.affiliateLink}
                target="_blank"
                rel="nofollow noopener noreferrer"
                class="mt-4 block w-full bg-primary hover:bg-primary/90 text-primary-foreground font-black py-4 px-6 rounded-2xl text-center shadow-xl shadow-primary/20"
                onclick="trackEnrollClick()"
              >
                Enroll Free Now
              </a>
              <div class="mt-5">
                <ExpiryDisplay course={course} />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PREMIUM MOBILE CTA -->
  <div class="fixed bottom-0 left-0 right-0 p-4 bg-slate-950/90 backdrop-blur-xl border-t border-slate-800 z-50 lg:hidden rounded-t-[2.5rem] shadow-[0_-20px_50px_rgba(0,0,0,0.5)]">
    <div class="flex gap-4 items-center max-w-lg mx-auto">
      <div class="flex-1">
        <div class="text-[10px] text-slate-500 font-black uppercase tracking-widest line-through mb-1">{course.originalPrice}</div>
        <div class="text-2xl font-black text-white">
          FREE
          <span class="text-primary text-xs ml-1 font-bold">{course.discount}</span>
        </div>
      </div>
      <a
        href={course.affiliateLink}
        target="_blank"
        rel="nofollow noopener noreferrer"
        class="bg-primary hover:bg-primary/90 text-primary-foreground font-black py-4 px-10 rounded-2xl flex-1 text-center shadow-lg shadow-primary/20 text-sm"
        onclick="trackEnrollClick()"
      >
        GET DEAL
      </a>
    </div>
  </div>
</MainLayout>

<script is:inline>
  function setupCouponReveal() {
    const containers = document.querySelectorAll('[data-coupon-reveal]');
    containers.forEach((container) => {
      container.addEventListener('click', function () {
        const code = this.getAttribute('data-code');
        const textSpan = this.querySelector('.coupon-text');
        const feedback = this.querySelector('.feedback-text');

        if (!code || !textSpan || !feedback) return;

        navigator.clipboard.writeText(code);

        textSpan.classList.remove('blur-[4px]', 'text-slate-400');
        textSpan.textContent = code;
        textSpan.classList.add('font-black', 'text-white', 'tracking-[0.1em]');

        const wrapper = this.querySelector('.relative');
        if (wrapper) {
          wrapper.classList.remove('border-dashed');
          wrapper.classList.add('border-solid', 'border-primary/50', 'bg-slate-900');
        }

        const overlay = this.querySelector('.absolute.inset-0');
        if (overlay) overlay.classList.add('hidden');

        feedback.innerHTML = '<span class="text-green-500">✓ COPIED TO CLIPBOARD</span>';

        setTimeout(() => {
          feedback.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-bounce"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg> RE-COPY CODE';
        }, 3000);

        if (typeof gtag !== 'undefined') {
          gtag('event', 'copy_coupon');
        }
      });
    });
  }

  function trackEnrollClick() {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'enroll_click');
    }
  }

  setupCouponReveal();
  document.addEventListener('astro:after-swap', setupCouponReveal);
</script>
