---
import MainLayout from '../../layouts/MainLayout.astro';
import SEO from '../../components/SEO.astro';
import coupons from '../../data/coupons.json';

export async function getStaticPaths() {
  // Get all unique categories from coupons.json data
  const categories = new Set<string>();
  
  coupons.forEach((coupon: any) => {
    if (coupon.category) {
      // Convert to slug format (lowercase, hyphenated, handle & properly)
      const categorySlug = coupon.category.toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/&amp;/g, '')
        .replace(/&/g, '-and-')
        .replace(/--/g, '-');
      categories.add(categorySlug);
    }
    if (coupon.subcategory) {
      // Convert to slug format (lowercase, hyphenated, handle & properly)
      const subcategorySlug = coupon.subcategory.toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/&amp;/g, '')
        .replace(/&/g, '-and-')
        .replace(/--/g, '-');
      categories.add(subcategorySlug);
    }
  });
  
  // Define expected category slugs based on actual data that exists
  const expectedCategories = [
    'it-and-software', 'web-development', 'data-science', 'business', 'design',
    'marketing', 'personal-development', 'photography-and-video'
  ];
  
  // Filter to only expected categories that have actual data
  const validCategories = expectedCategories.filter(cat => categories.has(cat));
  
  return validCategories.map((category) => ({
    params: { category },
    props: { category }
  }));
}

// Helper function to get discount percentage
function getDiscountPercentage(price: number | string | undefined, originalPrice: number | string | undefined): string {
  const p = typeof price === "string" ? parseFloat(price.replace(/[^\d.-]/g, "")) : price || 0;
  const op = typeof originalPrice === "string" ? parseFloat(originalPrice.replace(/[^\d.-]/g, "")) : originalPrice || 0;
  
  if (p === 0 || p < 0.1 || String(price).toLowerCase().includes("free")) {
    return "100%";
  } else if (op > 0) {
    return `${Math.round(((op - p) / op) * 100)}%`;
  }
  return "0%";
}

// Get category info based on actual data from coupons.json
function getCategoryInfo(categorySlug: string) {
  const categoryMap: Record<string, { name: string; icon: string; description: string }> = {
    'it-and-software': {
      name: 'IT & Software',
      icon: 'ðŸ’»',
      description: 'Master IT infrastructure, software development, cybersecurity, and system administration.'
    },
    'web-development': {
      name: 'Web Development',
      icon: 'âš›ï¸',
      description: 'Learn modern web development with React, JavaScript, HTML, CSS, and frontend frameworks.'
    },
    'data-science': {
      name: 'Data Science',
      icon: 'ðŸ“Š',
      description: 'Master data analysis, machine learning, data visualization, and big data technologies.'
    },
    'business': {
      name: 'Business',
      icon: 'ðŸ“ˆ',
      description: 'Develop business skills, entrepreneurship, management, and leadership expertise.'
    },
    'design': {
      name: 'Design',
      icon: 'ðŸŽ¨',
      description: 'Master graphic design, UI/UX design, web design, and creative skills.'
    },
    'marketing': {
      name: 'Marketing',
      icon: 'ðŸ“¢',
      description: 'Learn digital marketing, social media marketing, SEO, and growth strategies.'
    },
    'personal-development': {
      name: 'Personal Development',
      icon: 'ðŸŽ¯',
      description: 'Improve productivity, communication skills, time management, and personal growth.'
    },
    'photography-and-video': {
      name: 'Photography & Video',
      icon: 'ðŸ“·',
      description: 'Master photography, videography, photo editing, and video production skills.'
    }
  };
  
  return categoryMap[categorySlug] || {
    name: categorySlug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
    icon: 'ðŸ“š',
    description: `Find free courses in ${categorySlug.replace(/-/g, ' ')}`
  };
}

const { category } = Astro.props;
const categoryInfo = getCategoryInfo(category);

// Get courses for this category - improved filtering
const categoryCourses = coupons
  .filter((coupon: any) => {
    const categoryLower = coupon.category?.toLowerCase() || '';
    const subcategoryLower = coupon.subcategory?.toLowerCase() || '';
    
    // Convert category slug to match actual data format
    const categoryMap: Record<string, string> = {
      'it-and-software': 'it & software',
      'web-development': 'web development', 
      'data-science': 'data science',
      'business': 'business',
      'design': 'design',
      'marketing': 'marketing',
      'personal-development': 'personal development',
      'photography-and-video': 'photography & video'
    };
    
    const expectedCategory = categoryMap[category] || category.replace(/-/g, ' ');
    
    // Check both category and subcategory, handle HTML encoded ampersand
    return categoryLower === expectedCategory || 
           subcategoryLower === expectedCategory ||
           categoryLower.includes(expectedCategory) ||
           subcategoryLower.includes(expectedCategory) ||
           categoryLower.includes(expectedCategory.replace('&', '&amp;')) ||
           subcategoryLower.includes(expectedCategory.replace('&', '&amp;'));
  })
  .sort((a: any, b: any) => {
    // Sort by students (descending) then rating (descending)
    const studentsDiff = ((b as any).students || 0) - ((a as any).students || 0);
    if (studentsDiff !== 0) return studentsDiff;
    
    const ratingDiff = ((b as any).rating || 0) - ((a as any).rating || 0);
    return ratingDiff;
  });

// SEO data
const pageTitle = `${categoryInfo.name} Courses - Free Udemy Coupons | CoursesWyn`;
const pageDescription = `Find ${categoryCourses.length}+ free ${categoryInfo.name.toLowerCase()} courses with verified Udemy coupons. Get 100% off ${categoryInfo.name.toLowerCase()} courses with lifetime access.`;

// Structured data
const categorySchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `${categoryInfo.name} Courses`,
  "description": pageDescription,
  "url": `https://courseswyn.com/category/${category}`,
  "mainEntity": {
    "@type": "ItemList",
    "name": `${categoryInfo.name} Courses`,
    "description": pageDescription,
    "numberOfItems": categoryCourses.length,
    "itemListElement": categoryCourses.map((course: any, index: number) => ({
      "@type": "Course",
      "position": index + 1,
      "name": course.title,
      "description": course.description,
      "provider": {
        "@type": "Organization",
        "name": course.provider
      },
      "offers": {
        "@type": "Offer",
        "price": course.price === 0 ? "Free" : `$${course.price}`,
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock",
        "validFrom": course.createdAt,
        "url": `https://courseswyn.com/coupon/${course.slug}`
      }
    }))
  }
};
---

<MainLayout 
  title={pageTitle}
  description={pageDescription}
  canonical={`https://courseswyn.com/category/${category}`}
  ogImage={`https://courseswyn.com/og-category-${category}.jpg`}
  structuredData={categorySchema}
>
  <SEO 
    title={pageTitle}
    description={pageDescription}
    canonical={`https://courseswyn.com/category/${category}`}
    ogImage={`https://courseswyn.com/og-category-${category}.jpg`}
  />

  <!-- Breadcrumb Navigation -->
  <nav aria-label="Breadcrumb" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <ol class="flex items-center space-x-2 text-sm text-muted-foreground">
      <li>
        <a href="/" class="hover:text-foreground transition-colors">Home</a>
      </li>
      <li>
        <a href="/coupon" class="hover:text-foreground transition-colors">Coupons</a>
      </li>
      <li aria-current="page" class="text-foreground font-medium">{categoryInfo.name}</li>
    </ol>
  </nav>

  <!-- Category Header -->
  <section class="py-12 bg-card">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <div class="w-20 h-20 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-6">
          {categoryInfo.icon}
        </div>
        <h1 class="text-4xl font-bold text-foreground mb-4">
          {categoryInfo.name} Courses
        </h1>
        <p class="text-xl text-muted-foreground max-w-3xl mx-auto mb-8">
          {categoryInfo.description}
        </p>
        <div class="flex items-center justify-center gap-6 text-sm">
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span class="text-foreground font-medium">{categoryCourses.length}+ Courses</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
            <span class="text-foreground font-medium">100% Verified</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
            <span class="text-foreground font-medium">Updated Daily</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Courses Grid -->
  <section class="py-12 bg-background">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      {categoryCourses.length > 0 ? (
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {categoryCourses.map((course: any) => {
            const discount = getDiscountPercentage(course.price, course.originalPrice);
            const isFree = discount === "100%";
            
            return (
              <div class="bg-card rounded-xl border border-border overflow-hidden hover:shadow-lg transition-all group">
                
                {/* Course Image */}
                <div class="relative h-40 overflow-hidden">
                  <img 
                    src={course.image} 
                    alt={course.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                  />
                  
                  {/* Discount Badge */}
                  <div class="absolute top-3 right-3">
                    <span class={`px-3 py-1 rounded-full text-xs font-bold shadow-lg ${
                      isFree 
                        ? 'bg-green-500 text-white' 
                        : 'bg-primary text-white'
                    }`}>
                      {isFree ? 'FREE' : `${discount}% OFF`}
                    </span>
                  </div>
                  
                  {/* Rating Badge */}
                  {course.rating && (
                    <div class="absolute bottom-3 left-3 bg-background/90 backdrop-blur px-3 py-1 rounded-full border border-border">
                      <div class="flex items-center gap-1 text-sm">
                        <span class="text-amber-400">â˜…</span>
                        <span class="font-medium">{course.rating}</span>
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Course Content */}
                <div class="p-4">
                  <h3 class="font-semibold text-foreground mb-2 line-clamp-2 group-hover:text-primary transition-colors">
                    {course.title}
                  </h3>
                  
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <span class="text-lg font-bold text-foreground">
                        {isFree ? "Free" : `$${course.price}`}
                      </span>
                      {course.originalPrice && course.originalPrice > course.price && (
                        <span class="text-sm text-muted-foreground line-through ml-2">
                          ${course.originalPrice}
                        </span>
                      )}
                    </div>
                    
                    {course.students && (
                      <div class="text-xs text-muted-foreground">
                        {course.students.toLocaleString()} students
                      </div>
                    )}
                  </div>
                  
                  {course.instructor && (
                    <div class="text-sm text-muted-foreground mb-4">
                      By {course.instructor}
                    </div>
                  )}
                  
                  <a 
                    href={`/coupon/${course.slug}`}
                    class={`w-full py-3 rounded-lg font-medium transition-all text-center block ${
                      isFree 
                        ? 'bg-green-500 hover:bg-green-600 text-white' 
                        : 'bg-primary hover:bg-primary/90 text-primary-foreground'
                    }`}
                  >
                    {isFree ? 'Get Free Access' : 'Activate Deal'}
                  </a>
                </div>
              </div>
            );
          })}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="bg-muted/30 rounded-lg p-8 max-w-md mx-auto">
            <svg class="w-16 h-16 text-muted-foreground mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-foreground mb-2">No Courses Found</h3>
            <p class="text-muted-foreground">
              No courses found in {categoryInfo.name}. Check back soon for new courses.
            </p>
          </div>
        </div>
      )}
    </div>
  </section>

</MainLayout>
