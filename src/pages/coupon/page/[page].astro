---
import Layout from '../../../layouts/Layout.astro';
import courses from '../../../data/coupons.json';

const categories = [...new Set(courses.map(c => c.category))].sort();

// Helper functions for category slug handling
function createSlug(text: string): string {
  return text.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
}

function findCategoryFromSlug(slug: string): string | null {
  return categories.find(cat => createSlug(cat) === slug) || null;
}

// Parse URL parameters
const url = new URL(Astro.request.url);
const categorySlug = url.searchParams.get('category');
const currentCategory = categorySlug ? findCategoryFromSlug(categorySlug) : null;

// Filter courses by category if specified
const filteredCourses = currentCategory ? courses.filter(c => c.category === currentCategory) : courses;
const totalCourses = filteredCourses.length;

// Helper function to build URLs with category parameter
function buildUrl(pagePath: string): string {
  return currentCategory ? `${pagePath}?category=${createSlug(currentCategory)}` : pagePath;
}

// Pagination
const ITEMS_PER_PAGE = 12;
const currentPage = parseInt(Astro.params.page || '1');
const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
const endIndex = startIndex + ITEMS_PER_PAGE;
const paginatedCourses = filteredCourses.slice(startIndex, endIndex);
const totalPages = Math.ceil(totalCourses / ITEMS_PER_PAGE);

// Pagination pages
const pages = [];
const startPage = Math.max(1, currentPage - 2);
const endPage = Math.min(totalPages, currentPage + 2);

if (startPage > 1) {
  pages.push(1);
  if (startPage > 2) pages.push('...');
}

for (let i = startPage; i <= endPage; i++) {
  pages.push(i);
}

if (endPage < totalPages) {
  if (endPage < totalPages - 1) pages.push('...');
  pages.push(totalPages);
}

export async function getStaticPaths() {
  const ITEMS_PER_PAGE = 12;
  const totalPages = Math.ceil(courses.length / ITEMS_PER_PAGE);
  const maxPages = 50; // Limit to 50 pages for performance
  const paths = [];
  for (let page = 2; page <= Math.min(maxPages, totalPages); page++) {
    paths.push({ params: { page: page.toString() } });
  }
  return paths;
}
---

<Layout
  title={`Udemy Course Discounts | Up to 90% OFF - COURSESWYN`}
  description={`✅ ${totalCourses}+ verified 90% off Udemy coupons updated daily. Free premium courses in ${categories.join(', ')} with lifetime access & certificates. No credit card required. Start learning free today!`}
  keywords="udemy coupons, free udemy courses, 90% off udemy, udemy discount codes, free online courses, udemy deals, coupon codes udemy, udemy promo codes, free certification courses, online learning coupons"
>
  <header class="mb-8">
    <h1 class="text-4xl font-bold text-white mb-4">Browse Udemy Course Discounts</h1>
    <p class="text-lg text-slate-300 mb-4">Find your next course with verified 90% off deals and lifetime access.</p>
    <div class="flex flex-wrap gap-4 text-sm text-slate-400">
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        {totalCourses}+ Verified Coupons
      </span>
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        Updated Daily
      </span>
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        Lifetime Access
      </span>
    </div>
  </header>

  <!-- Filters -->
  <div class="mb-8">
    <!-- Category Search Input -->
    <div class="mb-4">
      <input
        type="text"
        id="category-search"
        placeholder="Search categories..."
        class="w-full max-w-md px-4 py-2 border border-slate-700 bg-slate-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      />
    </div>

    <div id="categories-container" class="flex flex-wrap gap-2">
      <a
        href="/coupon/"
        class={`px-4 py-2 rounded transition-colors ${!currentCategory ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
      >
        All Categories ({courses.length})
      </a>
      {categories.map(cat => {
        const isActive = cat === currentCategory;
        const slug = createSlug(cat);
        return (
          <a
            href={`/coupon/?category=${slug}`}
            class={`px-4 py-2 rounded transition-colors category-item ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
            data-category={cat.toLowerCase()}
          >
            {cat} ({courses.filter(c => c.category === cat).length})
          </a>
        );
      })}
    </div>
  </div>

  <!-- Course Grid -->
  <section id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {paginatedCourses.map(course => (
      <article class="block bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 rounded-lg shadow-sm hover:shadow-lg hover:border-blue-500 transition-all duration-200 overflow-hidden group">
        <div class="relative">
          <a href={`/coupon/${course.slug}`} aria-label={`Get ${course.discount} off ${course.title}`}>
            <img
              src={course.image}
              alt={`${course.title} - ${course.discount} off Udemy course by ${course.instructor}`}
              class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-200"
              loading="lazy"
              width="400"
              height="225"
            />
          </a>
          <div class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded font-semibold shadow-lg">
            {course.discount}
          </div>
        </div>
        <div class="p-4">
          <h3 class="font-semibold text-white mb-2 line-clamp-2 text-base leading-tight hover:text-blue-400 transition-colors">
            <a href={`/coupon/${course.slug}`}>{course.title}</a>
          </h3>

          {course.description && (
            <p class="text-xs text-slate-400 mb-2 line-clamp-2">{course.description}</p>
          )}

          <div class="text-xs text-slate-400 mb-2" aria-label={`Instructor: ${course.instructor}`}>
            {course.instructor}
          </div>

          <div class="flex items-center gap-1 mb-2 flex-wrap">
            <div class="bg-yellow-500/20 border border-yellow-500/30 rounded px-1.5 py-1 text-xs font-medium text-yellow-400" aria-label={`Rating: ${course.rating}`}>
              ★ {course.rating}
            </div>
            <div class="bg-slate-700 border border-slate-600 rounded px-1.5 py-1 text-xs text-slate-300" aria-label={`Students: ${course.students}`}>
              {course.students.toLocaleString()}
            </div>
            <div class="bg-slate-700 border border-slate-600 rounded px-1.5 py-1 text-xs text-slate-300" aria-label={`Duration: ${course.duration}`}>
              {course.duration}
            </div>
            <div class="bg-slate-700 border border-slate-600 rounded px-1.5 py-1 text-xs text-slate-300" aria-label={`Lectures: ${course.totalLectures}`}>
              {course.totalLectures} lec
            </div>
            <div class="bg-slate-700 border border-slate-600 rounded px-1.5 py-1 text-xs text-slate-300" aria-label={`Level: ${course.level}`}>
              {course.level}
            </div>
          </div>

          <div class="bg-red-600/20 border border-red-600/30 rounded-lg p-3 text-center mt-3">
            <div class="flex items-center justify-center space-x-2">
              <span class="text-lg font-bold text-red-400">{course.price}</span>
              <span class="text-sm text-slate-500 line-through">{course.originalPrice}</span>
            </div>
          </div>

          <a
            href={`/coupon/${course.slug}`}
            class="mt-3 inline-flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 font-medium transition-colors"
            aria-label={`View coupon details for ${course.title}`}
          >
            View Coupon →
          </a>
        </div>
      </article>
    ))}
  </section>

  <!-- Pagination -->
  {totalPages > 1 && (
    <div class="mt-8 flex justify-center">
      <nav class="flex space-x-2" aria-label="Pagination">
        {currentPage > 1 && (
          <a
            href={buildUrl(currentPage === 2 ? '/coupon/' : `/coupon/page/${currentPage - 1}`)}
            class="px-3 py-2 border border-slate-700 rounded hover:bg-slate-700 text-slate-300 transition-colors"
          >
            Previous
          </a>
        )}

        {pages.map(pageNum => (
          pageNum === '...' ? (
            <span class="px-3 py-2 border border-slate-700 text-slate-500">...</span>
          ) : (
            <a
              href={buildUrl(pageNum === 1 ? '/coupon/' : `/coupon/page/${pageNum}`)}
              class={`px-3 py-2 border rounded transition-colors ${
                pageNum === currentPage
                  ? 'bg-blue-600 text-white border-blue-600'
                  : 'border-slate-700 hover:bg-slate-700 text-slate-300'
              }`}
            >
              {pageNum}
            </a>
          )
        ))}

        {currentPage < totalPages && (
          <a
            href={buildUrl(`/coupon/page/${currentPage + 1}`)}
            class="px-3 py-2 border border-slate-700 rounded hover:bg-slate-700 text-slate-300 transition-colors"
          >
            Next
          </a>
        )}
      </nav>

      <p class="ml-4 text-sm text-slate-400 self-center">
        Page {currentPage} of {totalPages}
      </p>
    </div>
  )}

  <script>
    // Handle category search input
    function handleCategorySearch(event: Event) {
      const target = event.target as HTMLInputElement;
      const searchTerm = target.value.toLowerCase();
      const categoryItems = document.querySelectorAll('.category-item');

      categoryItems.forEach(item => {
        const categoryName = item.getAttribute('data-category');
        if (categoryName && categoryName.includes(searchTerm)) {
          (item as HTMLElement).style.display = 'inline-block';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      const searchInput = document.getElementById('category-search');
      if (searchInput) {
        searchInput.addEventListener('input', handleCategorySearch);
      }
    }

    // Initialize
    setupEventListeners();
  </script>
</Layout>