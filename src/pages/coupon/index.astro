---
import Layout from '../../layouts/Layout.astro';
import courses from '../../data/coupons.json';

const categories = [...new Set(courses.map(c => c.category))].sort();
---

<Layout
  title={`90% Off Udemy Coupons ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} - ${courses.length}+ Free Course Deals | CoursesWyn`}
  description={`✅ ${courses.length}+ verified 90% off Udemy coupons updated daily. Free premium courses in ${categories.join(', ')} with lifetime access & certificates. No credit card required. Start learning free today!`}
  keywords="udemy coupons, free udemy courses, 90% off udemy, udemy discount codes, free online courses, udemy deals, coupon codes udemy, udemy promo codes, free certification courses, online learning coupons"
>
  <header class="mb-8">
    <h1 id="page-title" class="text-4xl font-bold text-gray-900 mb-4">Browse Free Course Coupons</h1>
    <p id="page-description" class="text-lg text-gray-600 mb-4">Find your next course with verified 90% off deals and lifetime access.</p>
    <div class="flex flex-wrap gap-4 text-sm text-gray-500">
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <span id="total-count">{courses.length}</span>+ Verified Coupons
      </span>
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        Updated Daily
      </span>
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        Lifetime Access
      </span>
    </div>
  </header>

  <!-- Filters -->
  <div class="mb-8">
    <!-- Category Search Input -->
    <div class="mb-4">
      <input
        type="text"
        id="category-search"
        placeholder="Search categories..."
        class="w-full max-w-md px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
      />
    </div>

    <div id="filter-buttons" class="flex flex-wrap gap-2">
      <!-- Filter buttons will be generated by JavaScript -->
    </div>
  </div>

  <!-- Course Grid -->
  <section id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    <!-- Courses will be rendered by JavaScript -->
  </section>

  <!-- Pagination -->
  <div id="pagination-container" class="mt-8 flex justify-center" style="display: none;">
    <!-- Pagination will be generated by JavaScript -->
  </div>

  <script define:vars={{ courses, categories }}>
    const ITEMS_PER_PAGE = 12;
    let currentCategory = null;
    let currentPage = 1;
    let filteredCourses = courses;
    let categorySearchTerm = '';

    // Course card template
    function createCourseCard(course) {
      return `
        <article class="block bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden group">
          <div class="relative">
            <a href="/coupon/${course.slug}" aria-label="Get ${course.discount} off ${course.title}">
              <img
                src="${course.image}"
                alt="${course.title} - ${course.discount} off Udemy course by ${course.instructor}"
                class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-200"
                loading="lazy"
                width="400"
                height="225"
              />
            </a>
            <div class="absolute top-2 right-2 bg-black/80 text-white text-xs px-2 py-1 rounded font-semibold shadow-lg">
              ${course.discount}
            </div>
          </div>
          <div class="p-4">
            <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2 text-base leading-tight hover:text-purple-600 transition-colors">
              <a href="/coupon/${course.slug}">${course.title}</a>
            </h3>
            ${course.description ? `<p class="text-xs text-gray-600 mb-2 line-clamp-2">${course.description}</p>` : ''}
            <div class="text-xs text-gray-500 mb-2" aria-label="Instructor: ${course.instructor}">
              ${course.instructor}
            </div>
            <div class="flex items-center gap-1 mb-2 flex-wrap">
              <div class="bg-yellow-50 border border-yellow-300 rounded px-1.5 py-1 text-xs font-medium text-yellow-800" aria-label="Rating: ${course.rating}">
                ★ ${course.rating}
              </div>
              <div class="bg-gray-100 border border-gray-300 rounded px-1.5 py-1 text-xs" aria-label="Students: ${course.students}">
                ${course.students.toLocaleString()}
              </div>
              <div class="bg-gray-100 border border-gray-300 rounded px-1.5 py-1 text-xs" aria-label="Duration: ${course.duration}">
                ${course.duration}
              </div>
              <div class="bg-gray-100 border border-gray-300 rounded px-1.5 py-1 text-xs" aria-label="Lectures: ${course.totalLectures}">
                ${course.totalLectures} lec
              </div>
              <div class="bg-gray-100 border border-gray-300 rounded px-1.5 py-1 text-xs" aria-label="Level: ${course.level}">
                ${course.level}
              </div>
            </div>
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center mt-3">
              <div class="flex items-center justify-center space-x-2">
                <span class="text-lg font-bold text-purple-600">${course.price}</span>
                <span class="text-sm text-gray-500 line-through">${course.originalPrice}</span>
              </div>
            </div>
            <a
              href="/coupon/${course.slug}"
              class="mt-3 inline-flex items-center gap-2 text-sm text-purple-600 hover:text-purple-700 font-medium transition-colors"
              aria-label="View coupon details for ${course.title}"
            >
              View Coupon →
            </a>
          </div>
        </article>
      `;
    }

    // Update page content
    function updatePageContent() {
      const titleElement = document.getElementById('page-title');
      const descriptionElement = document.getElementById('page-description');
      const totalCountElement = document.getElementById('total-count');

      if (currentCategory) {
        titleElement.textContent = `Free ${currentCategory} Course Coupons`;
        descriptionElement.textContent = `Find verified 90% off ${currentCategory.toLowerCase()} courses with lifetime access.`;
        totalCountElement.textContent = filteredCourses.length;
      } else {
        titleElement.textContent = 'Browse Free Course Coupons';
        descriptionElement.textContent = 'Find your next course with verified 90% off deals and lifetime access.';
        totalCountElement.textContent = courses.length;
      }
    }

    // Generate filter buttons
    function generateFilterButtons() {
      const container = document.getElementById('filter-buttons');
      const filteredCategories = categories.filter(cat =>
        cat.toLowerCase().includes(categorySearchTerm.toLowerCase())
      );

      let html = `
        <button
          id="filter-all"
          class="px-4 py-2 rounded transition-colors ${!currentCategory ? 'bg-purple-500 text-white hover:bg-purple-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
          onclick="filterCourses('all')"
        >
          All Categories (${courses.length})
        </button>
      `;

      filteredCategories.forEach(cat => {
        const count = courses.filter(c => c.category === cat).length;
        html += `
          <button
            id="filter-${cat.toLowerCase().replace(/\s+/g, '-')}"
            class="px-4 py-2 rounded transition-colors ${currentCategory === cat ? 'bg-purple-500 text-white hover:bg-purple-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
            onclick="filterCourses('${cat}')"
          >
            ${cat} (${count})
          </button>
        `;
      });

      container.innerHTML = html;
    }

    // Render courses
    function renderCourses() {
      const grid = document.getElementById('courses-grid');
      const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      const coursesToShow = filteredCourses.slice(startIndex, endIndex);

      grid.innerHTML = coursesToShow.map(createCourseCard).join('');
    }

    // Render pagination
    function renderPagination() {
      const container = document.getElementById('pagination-container');
      const totalPages = Math.ceil(filteredCourses.length / ITEMS_PER_PAGE);

      if (totalPages <= 1) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'flex';

      let html = '<nav class="flex space-x-2" aria-label="Pagination">';

      // Previous button
      if (currentPage > 1) {
        const prevUrl = currentPage === 2 ? '/coupon/' : `/coupon/page/${currentPage - 1}`;
        const url = currentCategory ? `${prevUrl}?category=${createSlug(currentCategory)}` : prevUrl;
        html += `<a href="${url}" class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">Previous</a>`;
      }

      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      if (startPage > 1) {
        const url = currentCategory ? `/coupon/?category=${createSlug(currentCategory)}` : '/coupon/';
        html += `<a href="${url}" class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">1</a>`;
        if (startPage > 2) {
          html += '<span class="px-3 py-2 border border-gray-300 text-gray-500">...</span>';
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        const pageUrl = i === 1 ? '/coupon/' : `/coupon/page/${i}`;
        const url = currentCategory ? `${pageUrl}?category=${createSlug(currentCategory)}` : pageUrl;
        html += `<a href="${url}" class="px-3 py-2 border rounded transition-colors ${isActive ? 'bg-purple-500 text-white border-purple-500' : 'border-gray-300 hover:bg-gray-50 text-gray-700'}">${i}</a>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += '<span class="px-3 py-2 border border-gray-300 text-gray-500">...</span>';
        }
        const url = currentCategory ? `/coupon/page/${totalPages}?category=${createSlug(currentCategory)}` : `/coupon/page/${totalPages}`;
        html += `<a href="${url}" class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">${totalPages}</a>`;
      }

      // Next button
      if (currentPage < totalPages) {
        const url = currentCategory ? `/coupon/page/${currentPage + 1}?category=${createSlug(currentCategory)}` : `/coupon/page/${currentPage + 1}`;
        html += `<a href="${url}" class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">Next</a>`;
      }

      html += '</nav>';
      html += `<p class="ml-4 text-sm text-gray-600 self-center">Page ${currentPage} of ${totalPages}</p>`;

      container.innerHTML = html;
    }

    // Helper function to create URL slug from category name
    function createSlug(name) {
      return name.toLowerCase()
        .replace(/[^a-z0-9\s]/g, '') // Remove special chars like &
        .replace(/\s+/g, '-') // Replace spaces with hyphens
        .trim();
    }

    // Helper function to find category from URL slug
    function findCategoryFromSlug(slug) {
      return categories.find(cat => createSlug(cat) === slug) || slug;
    }

    // Filter courses
    function filterCourses(category) {
      if (category === 'all') {
        currentCategory = null;
        filteredCourses = courses;
        const url = new URL(window.location);
        url.searchParams.delete('category');
        window.history.pushState({}, '', url);
      } else {
        // Handle both display names and URL slugs
        const actualCategory = findCategoryFromSlug(category);
        currentCategory = actualCategory;
        filteredCourses = courses.filter(c => c.category.toLowerCase() === actualCategory.toLowerCase());
        const url = new URL(window.location);
        url.searchParams.set('category', createSlug(actualCategory));
        window.history.pushState({}, '', url);
      }

      currentPage = 1;
      updatePageContent();
      generateFilterButtons();
      renderCourses();
      renderPagination();
    }

    // Initialize on page load
    function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const categoryParam = urlParams.get('category');

      if (categoryParam) {
        // Convert URL slug back to actual category name for filtering
        const actualCategory = findCategoryFromSlug(categoryParam);
        filterCourses(actualCategory);
      } else {
        updatePageContent();
        generateFilterButtons();
        renderCourses();
        renderPagination();
      }
    }

    // Handle category search input
    function handleCategorySearch(event) {
      categorySearchTerm = event.target.value;
      generateFilterButtons();
    }

    // Setup event listeners
    function setupEventListeners() {
      const searchInput = document.getElementById('category-search');
      if (searchInput) {
        searchInput.addEventListener('input', handleCategorySearch);
      }
    }

    // Make filterCourses global
    window.filterCourses = filterCourses;

    // Initialize
    init();
    setupEventListeners();
  </script>
</Layout>

