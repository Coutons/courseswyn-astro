---
import MainLayout from "../../layouts/MainLayout.astro";
import courses from "../../data/coupons.json";
import CourseCard from "../../components/CourseCard.astro";

export async function getStaticPaths() {
  return courses.filter((c: any) => c.slug).map((course: any) => ({
    params: { slug: course.slug },
    props: { course },
  }));
}

const { course } = Astro.props;

// Data Logic
const relatedCourses = courses
  .filter((c: any) => c.category === course.category && c.slug !== course.slug)
  .sort(() => 0.5 - Math.random())
  .slice(0, 4);

// --- SHARED DATA ---
const date = new Date();
const currentMonth = date.toLocaleDateString('en-US', { month: 'long' });
const currentYear = date.getFullYear();
const isFree = course.price === 0 || course.price === "Free";

const faqs = isFree ? [
  {
    q: `Is ${course.title} really free?`,
    a: `Yes, ${course.title} is completely free with our exclusive coupon code. You can enroll for $0.`
  },
  {
    q: "How do I get this course for free?",
    a: 'Click the "Get Course" button on this page to access the course with our 100% OFF coupon code applied automatically.'
  },
  {
    q: `How long is this free course?`,
    a: `The course is approximately ${course.duration || 'a few hours'} long and you get full lifetime access once enrolled.`
  }
] : [
  {
    q: `Is there a discount for ${course.title}?`,
    a: `Yes, we provide the best verified Udemy coupon for ${course.title}. You can get it at the lowest possible price.`
  },
  {
    q: "How do I apply the coupon code?",
    a: 'Simply click the "Get Course" button. The best available discount code is applied automatically to your link.'
  },
  {
    q: `How long is this course?`,
    a: `${course.title} is approximately ${course.duration || 'a few hours'} long with comprehensive content.`
  }
];

// Add a general FAQ that's always relevant
faqs.push({
  q: `What will I learn in ${course.title}?`,
  a: `${course.title} by ${course.instructor || 'expert instructors'}. You will master key skills in ${course.category}.`
});

// --- SEO LOGIC ---
const nextMonthDate = new Date();
nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
const priceValidUntil = nextMonthDate.toISOString().split('T')[0];
// "SEO Killer" Title: Priority on [Title] + Coupon + Date
// Truncate course title if too long to keep total under 70 chars
const shortTitle = course.title.length > 50 ? course.title.substring(0, 47) + "..." : course.title;
const pageTitle = `${shortTitle} Coupon - ${currentMonth} ${currentYear}`;

const pageDescription = `Verified Udemy coupon for ${course.title}. ${isFree ? 'Get it for 100% OFF today.' : 'Get the maximum discount.'} Updated for ${currentMonth} ${currentYear}.`;

// JSON-LD Course Schema
const courseSchema = {
  "@context": "https://schema.org",
  "@type": "Course",
  "name": course.title,
  "description": course.description?.substring(0, 160),
  "provider": {
    "@type": "Organization",
    "name": "Udemy",
    "sameAs": "https://www.udemy.com"
  },
  "image": course.image,
  "offers": {
    "@type": "Offer",
    "price": isFree ? "0" : course.price,
    "priceCurrency": "USD",
    "priceValidUntil": priceValidUntil,
    "availability": "https://schema.org/InStock",
    "url": Astro.url.href
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": course.rating || 4.5,
    "reviewCount": course.students || 100
  }
};

// JSON-LD Breadcrumb Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Udemy Coupon Code",
      "item": `${Astro.site}udemy-coupon-code`
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": course.title,
      "item": Astro.url.href
    }
  ]
};

// JSON-LD FAQ Schema
const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map(f => ({
    "@type": "Question",
    "name": f.q,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": f.a
    }
  }))
};
---

<MainLayout title={pageTitle} description={pageDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(courseSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  <div class="bg-[#1a1d29] min-h-screen pb-20 pt-10 px-4">
    <div class="max-w-4xl mx-auto space-y-10">

      <!-- 1. IMAGE COURSES -->
      <section class="relative">
        <img 
            src={course.image} 
            alt={course.title} 
            class="w-full rounded-2xl shadow-2xl border border-[#2d3748]" 
        />
        <div class="absolute top-4 left-4 bg-black/60 backdrop-blur-md px-3 py-1 rounded-lg text-xs text-gray-300">
            {course.createdAt ? "7 minutes ago" : "Newly Added"}
        </div>
        <button class="absolute top-4 right-4 p-2 bg-black/40 backdrop-blur-md rounded-full text-white hover:text-red-500 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
        </button>
      </section>

      <!-- 2. UDEMY - DURATION - STUDENT - LANGUAGE - PRICE -->
      <section class="flex flex-col md:flex-row items-center justify-between gap-6 pb-6 border-b border-[#2d3748]">
        <div class="flex flex-wrap gap-2">
            <span class="flex items-center gap-2 bg-[#1f2937] px-3 py-2 rounded-lg text-sm font-medium text-gray-300 border border-[#2d3748]">
                <span class="text-xs">üíº</span> Udemy
            </span>
            <span class="flex items-center gap-2 bg-[#1f2937] px-3 py-2 rounded-lg text-sm font-medium text-gray-300 border border-[#2d3748]">
                <span class="text-xs">üïí</span> {course.duration || "N/A"}
            </span>
            <span class="flex items-center gap-2 bg-[#1f2937] px-3 py-2 rounded-lg text-sm font-medium text-gray-300 border border-[#2d3748]">
                <span class="text-xs">üëÅÔ∏è</span> {course.students || 0}
            </span>
            <span class="flex items-center gap-2 bg-[#1f2937] px-3 py-2 rounded-lg text-sm font-medium text-gray-300 border border-[#2d3748]">
                <span class="text-xs">üåê</span> English
            </span>
        </div>
        <div class="bg-[#242938] px-4 py-2 rounded-xl border border-[#2d3748] flex items-center gap-3">
            <span class="text-gray-500 line-through text-sm">${course.originalPrice || "84.99"}</span>
            <span class="text-[#00c853] font-bold text-2xl">
                {course.price === 0 || course.price === "Free" ? "$0" : `$${course.price}`}
            </span>
        </div>
      </section>

      <!-- 3. CATEGORY AND SUB CATEGORY -->
      <section class="flex items-center gap-2 text-sm">
        <a href="/categories" class="bg-[#242938] px-4 py-2 rounded-lg text-gray-300 hover:text-white border border-[#2d3748]">
            {course.category}
        </a>
        <span class="text-gray-600">‚Ä∫</span>
        <span class="bg-[#242938] px-4 py-2 rounded-lg text-gray-300 border border-[#2d3748]">
            {course.subcategory || (course.subCategory || "General")}
        </span>
      </section>

      <!-- 3. DETAIL KURUS DARI DATA COUPON.JSON -->
      <section class="space-y-10">
        <div>
            <h1 class="text-3xl md:text-5xl font-black text-white leading-tight mb-4">
                {course.title}
            </h1>
            <p class="text-lg text-gray-400 italic">
                {course.description}
            </p>
        </div>

        {course.learn && course.learn.length > 0 && (
          <div class="bg-[#242938] p-6 rounded-2xl border border-[#2d3748]">
            <h2 class="text-xl font-bold text-white mb-6">What you'll learn in this Udemy Course</h2>
            <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {course.learn.map((item: string) => (
                    <li class="flex items-start gap-3 text-sm text-gray-300">
                        <span class="text-[#00c853] flex-shrink-0">‚úì</span>
                        {item}
                    </li>
                ))}
            </ul>
          </div>
        )}

        {course.requirements && course.requirements.length > 0 && (
            <div class="space-y-4">
                <h2 class="text-2xl font-bold text-white">Udemy Coupon Requirements</h2>
                <ul class="list-disc pl-6 space-y-2 text-gray-300">
                    {course.requirements.map((req: string) => (
                        <li>{req}</li>
                    ))}
                </ul>
            </div>
        )}

        {course.content && (
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-white">About This Udemy Coupon</h2>
                <div class="prose prose-invert max-w-none text-gray-300 leading-relaxed prose-headings:text-white prose-a:text-[#00c853] prose-strong:text-white" set:html={course.content} />
            </div>
        )}
      </section>

      <!-- 4. TOMBOL ENROLL -->
      <section class="pt-6">
        <a
            href={course.url}
            target="_blank"
            rel="nofollow noopener"
            class="w-full flex items-center justify-center gap-3 bg-[#059669] hover:bg-[#047857] text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg border border-[#10b981]/20"
        >
            <span class="text-lg uppercase tracking-wide">Get Udemy Coupon</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
        </a>
        <div class="mt-3 flex items-center justify-center gap-4 text-[10px] text-gray-500 font-bold uppercase tracking-[0.1em]">
            <span class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 bg-[#059669] rounded-full"></span> 100% Verified</span>
            <span class="flex items-center gap-1.5">üõ°Ô∏è SECURE ACCESS</span>
            <span class="flex items-center gap-1.5">‚ö° FAST REDEEM</span>
        </div>
      </section>

      <div class="h-px bg-[#2d3748] w-full"></div>

      <!-- 5. SIMILAR COURSE -->
      <section>
        <h2 class="text-2xl font-bold text-white mb-8">Related Udemy Coupon Codes</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            {relatedCourses.map((c: any) => <CourseCard course={c} />)}
        </div>
        <div class="mt-10 flex justify-center">
            <a href="/udemy-coupon-code" class="bg-[#1f2937] hover:bg-[#2d3748] text-white px-8 py-3 rounded-xl border border-[#2d3748] flex items-center gap-2 font-bold transition-all">
                Load More
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </a>
        </div>
      </section>

      <!-- 6. FAQS -->
      <section>
        <h2 class="text-3xl font-bold text-white mb-8">Frequently Asked Questions</h2>
        <div class="space-y-6">
            {faqs.map(faq => (
                <div class="group border-b border-[#2d3748] pb-6">
                    <h3 class="text-[#00c853] font-bold text-lg mb-3 leading-snug">
                        {faq.q}
                    </h3>
                    <p class="text-sm text-gray-400 leading-relaxed">
                        {faq.a}
                    </p>
                </div>
            ))}
        </div>
      </section>

      <!-- 7. COURSE INFORMATION -->
      <section class="bg-[#242938] border border-[#2d3748] rounded-3xl p-8 shadow-2xl">
        <h2 class="text-2xl font-bold text-white mb-8">Course Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-y-8 gap-x-12">
            <div>
                <p class="text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">Platform</p>
                <p class="text-white font-bold text-xl">Udemy</p>
            </div>
            <div>
                <p class="text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">Duration</p>
                <p class="text-white font-bold text-xl">{course.duration || "N/A"}</p>
            </div>
            <div>
                <p class="text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">Language</p>
                <p class="text-white font-bold text-xl">English</p>
            </div>
            <div>
                <p class="text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">Category</p>
                <p class="text-white font-bold text-lg">{course.category} ‚Ä¢ {course.subcategory || "General"}</p>
            </div>
            <div>
                <p class="text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">Rating</p>
                <div class="flex items-center gap-2">
                    <span class="text-yellow-400 text-lg">‚≠ê</span>
                    <span class="text-white font-bold text-xl">{course.rating || "N/A"} <span class="text-gray-500 text-sm font-medium">({course.students?.toLocaleString() || 0} enrolled)</span></span>
                </div>
            </div>
            <div>
                <p class="text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">Price</p>
                <div class="flex items-center gap-2 font-bold text-xl">
                    <span class={`${course.price === 0 || course.price === "Free" ? 'text-[#00c853]' : 'text-white'}`}>
                        {course.price === 0 || course.price === "Free" ? 'FREE' : `$${course.price}`}
                    </span>
                    <span class="text-gray-500 line-through text-lg mb-0.5">${course.originalPrice || "84.99"}</span>
                </div>
            </div>
        </div>
      </section>

    </div>
  </div>
</MainLayout>

