---
import Layout from "../../layouts/Layout.astro";
import DealCard from "../../components/coupon/DealCard.astro";
import coupons from "../../data/coupons.json";

const CATEGORY = "Python & Programming";
const ITEMS_PER_PAGE = 12;

export async function getStaticPaths() {
  return [{ params: {} }];
}

const pyCoupons = coupons.filter(
  (c) => c.subCategory === CATEGORY || c.category === "Programming",
);
const totalCoupons = pyCoupons.length;
const currentMonthYear = new Date().toLocaleDateString("en-US", {
  month: "long",
  year: "numeric",
});
const couponsLast24h = pyCoupons.filter((c) => {
  const now = new Date();
  const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
  return new Date(c.addedDate) >= oneDayAgo && new Date(c.addedDate) <= now;
}).length;

const schema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Best Python Courses - Free Udemy Coupons",
  description: `Free Python & Programming courses (${totalCoupons}) with verified coupons`,
  numberOfItems: Math.min(totalCoupons, 20),
};
const couponsJSON = JSON.stringify(pyCoupons);
const showPagination = Math.ceil(pyCoupons.length / ITEMS_PER_PAGE) > 1;
---

<script define:vars={{ couponsJSON, ITEMS_PER_PAGE }}>
  const couponsData = JSON.parse(couponsJSON);
  let currentPage = 1;
  window.goToPage = function (page) {
    currentPage = Math.max(
      1,
      Math.min(page, Math.ceil(couponsData.length / ITEMS_PER_PAGE)),
    );
    update();
    window.scrollTo({
      top: document.getElementById("coupons-grid").offsetTop - 100,
      behavior: "smooth",
    });
  };
  function update() {
    const grid = document.getElementById("coupons-grid");
    if (!grid) return;
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    document.querySelectorAll("[data-coupon-slug]").forEach((card) => {
      const slug = card.getAttribute("data-coupon-slug");
      card.style.display = couponsData
        .slice(start, end)
        .some((c) => c.slug === slug)
        ? ""
        : "none";
    });
    const controls = document.getElementById("pagination-controls");
    if (controls) {
      controls.innerHTML = "";
      const totalPages = Math.ceil(couponsData.length / ITEMS_PER_PAGE);
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const b = document.createElement("button");
        b.textContent = String(i);
        b.className = `px-3 py-2 rounded ${i === currentPage ? "bg-blue-600 text-white" : "bg-slate-800 text-slate-300"}`;
        b.onclick = () => {
          currentPage = i;
          update();
        };
        controls.appendChild(b);
      }
    }
  }
  document.addEventListener("DOMContentLoaded", update);
</script>

<Layout
  title={`Best Python & Programming Free Courses - ${currentMonthYear}`}
  description={`Browse ${totalCoupons}+ free Python & programming courses with verified 100% off Udemy coupons.`}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  <main>
    <section
      class="relative overflow-hidden bg-gradient-to-b from-slate-950 via-slate-900 to-slate-800 py-20"
    >
      <div class="max-w-7xl mx-auto px-4 text-center">
        <div
          class="inline-flex items-center gap-2 mb-6 px-4 py-2 bg-blue-500/20 border border-blue-500/40 rounded-full"
        >
          <span class="text-blue-300"
            >⚡ {totalCoupons}+ Free Python Courses</span
          >
        </div>
        <h1 class="text-4xl font-black text-white mb-4">
          Master <span
            class="bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent"
            >Python & Programming</span
          > — For Free
        </h1>
        <p class="text-slate-300 mb-8">
          Get lifetime access to top Python courses with verified free coupons. {
            couponsLast24h
          }+ new courses added daily.
        </p>
        <div class="flex gap-4 justify-center mb-12">
          <a
            href="#coupons-grid"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg"
            >Browse Courses</a
          ><a
            href="/coupon/"
            class="px-6 py-3 border border-slate-700 text-slate-300 rounded-lg"
            >All Categories</a>
        </div>
      </div>
    </section>

    <section class="max-w-7xl mx-auto px-4 py-16">
      <h2 class="text-2xl font-black text-white mb-4">Top Python Deals</h2>
      <p class="text-slate-400 mb-6">
        Handpicked Python courses with highest ratings and verified coupons.
      </p>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          pyCoupons.slice(0, 6).map((c) => (
            <div data-coupon-slug={c.slug}>
              <DealCard {...c} />
            </div>
          ))
        }
      </div>
    </section>

    <section class="max-w-7xl mx-auto px-4 py-16">
      <div id="coupons-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          pyCoupons.map((c) => (
            <div data-coupon-slug={c.slug}>
              <DealCard {...c} />
            </div>
          ))
        }
      </div>
      {
        showPagination && (
          <nav
            id="pagination-controls"
            class="flex justify-center gap-2 mt-8"
          />
        )
      }
    </section>
  </main>
</Layout>
