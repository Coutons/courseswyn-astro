---
import "../styles/global.css";
import Search from "../components/Search.astro";
import BackToTop from "../components/BackToTop.astro";
import coupons from "../data/coupons.json";
import { fetchPosts } from "../lib/posts";
import { SEO } from "astro-seo";

interface Props {
  title: string;
  description: string;
  canonical?: string;
  ogImage?: string;
  keywords?: string;
  structuredData?: Record<string, any>;
  paginationNext?: string;
  paginationPrev?: string;
}

const { title, description, canonical, ogImage, keywords, structuredData, paginationNext, paginationPrev } = Astro.props;
const currentPath = Astro.url.pathname;
const segments = currentPath.split("/").filter(Boolean);
const isHomepage = currentPath === "/";
const isCouponPage = currentPath.startsWith("/coupon/");
const isLightTheme = false;

// Keep title as is - don't add extra text to maintain optimal SEO length
const metaTitle = title;
const defaultOgImage = "https://courseswyn.com/images/og-default.svg";
const finalOgImage = ogImage || defaultOgImage;
const finalCanonical = canonical || new URL(currentPath, Astro.site).href;
const allPosts = await fetchPosts();
---

<html lang="en" class={`min-h-full bg-surface text-white`}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <SEO
      title={metaTitle}
      description={description}
      canonical={finalCanonical}
      openGraph={{
        basic: {
          title: metaTitle,
          type: "website",
          image: finalOgImage,
          url: finalCanonical,
        },
        optional: {
          description: description,
        },
      }}
      twitter={{
        card: "summary_large_image",
        title: metaTitle,
        description: description,
        image: finalOgImage,
      }}
      extend={{
        link: [
          { rel: "alternate", hreflang: "en", href: finalCanonical },
          ...(paginationNext ? [{ rel: "next", href: paginationNext }] : []),
          ...(paginationPrev ? [{ rel: "prev", href: paginationPrev }] : []),
        ],
        meta: [
          { name: "author", content: "CoursesWyn" },
          ...(keywords ? [{ name: "keywords", content: keywords }] : []),
        ],
      }}
    />

    <!-- Additional SEO meta tags -->
    <meta name="author" content="CoursesWyn" />
    {keywords && <meta name="keywords" content={keywords} />}
    <link rel="canonical" href={finalCanonical} />

    <!-- Performance and SEO monitoring -->
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
    <meta name="googlebot" content="index, follow" />
    <meta name="bingbot" content="index, follow" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script is:inline>
      if (typeof window !== "undefined" && typeof document !== "undefined") {
        const root = document.documentElement;
        const storedTheme = localStorage.getItem("courseswyn-theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const nextTheme = storedTheme ?? (prefersDark ? "dark" : "light");
        root.dataset.theme = nextTheme;
        root.classList.toggle("dark", nextTheme === "dark");
      }
    </script>
    <script is:inline>
      if (typeof window !== "undefined" && typeof document !== "undefined") {
        window.__COURSESWYN_TOGGLE__ = () => {
          const root = document.documentElement;
          const current = root.dataset.theme === "dark" ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          root.dataset.theme = next;
          root.classList.toggle("dark", next === "dark");
          localStorage.setItem("courseswyn-theme", next);
        };
      }
    </script>

    <!-- Organization Schema -->
    <script type="application/ld+json" is:inline>
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "CoursesWyn",
        "url": "https://courseswyn.com",
        "description": "COURSESWYN ‚Ä¢ 100% Off Udemy Coupons - ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} - Coupon Scorpion, Groupon, Grabbon, Real Discount, Discudemy, CouponFollow - COURSESWYN",
        "logo": {
          "@type": "ImageObject",
          "url": "https://courseswyn.com/favicon.svg",
          "width": 32,
          "height": 32
        },
        "foundingDate": "2023",
        "sameAs": ["https://twitter.com/CoursesGift"]
      }
    </script>

    {
      structuredData && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(structuredData)}
        />
      )
    }

    <!-- Additional SEO Structured Data for Homepage -->
    {isHomepage && (
      <script type="application/ld+json" is:inline>
        {JSON.stringify({
          "@context": "https://schema.org",
          "@type": "WebPage",
          "name": `COURSESWYN - Udemy Coupons - Verified Daily [${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}]`,
          "description": `${coupons.length}+ verified 100% off Udemy coupons updated daily. Free premium courses worth $200+ with lifetime access and professional certificates. No credit card required.`,
          "url": "https://courseswyn.com",
          "publisher": {
            "@type": "Organization",
            "name": "CoursesWyn",
            "url": "https://courseswyn.com"
          }
        })}
      </script>
    )}

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GT-55B77QRB"
    ></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "GT-55B77QRB");

      // Scroll depth tracking
      let scrollDepthTracked = false;
      window.addEventListener("scroll", () => {
        if (
          !scrollDepthTracked &&
          window.scrollY > 0.5 * document.body.scrollHeight
        ) {
          scrollDepthTracked = true;
          gtag("event", "scroll_50", {
            event_category: "engagement",
            value: 50,
          });
        }
      });
    </script>

    </head>
  <body class={`min-h-screen antialiased bg-surface text-white`}>
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-lg font-semibold"
      >Skip to content</a
    >
    <div
      class="absolute inset-0 -z-10 bg-grid-mesh [background-size:60px_60px]"
    >
    </div>
    <header
      class="sticky top-0 z-50 border-b border-slate-700 bg-slate-900/95 backdrop-blur-lg shadow-lg"
    >
      <div class="mx-auto max-w-7xl px-4">
        <div class="flex items-center justify-between gap-4 h-20">
          <!-- Logo -->
          <a
            href="/"
            class="flex items-center gap-2 text-lg font-bold tracking-tight group shrink-0"
          >
            <span
              class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-blue-600 text-white font-black border border-blue-500 group-hover:border-blue-400 group-hover:shadow-lg group-hover:shadow-blue-500/30 transition-all"
            >
              CW
            </span>
            <span class="hidden sm:inline text-blue-400 font-bold">CoursesWyn</span>
          </a>

          <!-- Categories Dropdown (Desktop) -->
          <div class="hidden md:block relative group z-50">
            <button class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-all border border-transparent hover:border-slate-700">
              üìö Categories
              <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="absolute top-full left-0 mt-2 w-72 bg-slate-800/95 backdrop-blur-xl border border-slate-700 rounded-xl p-3 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform origin-top-left">
              <div class="grid grid-cols-1 gap-1">
                <a href="/coupon/development/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">üíª Development</a>
                <a href="/coupon/business/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">üíº Business</a>
                <a href="/coupon/design/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">üé® Design</a>
                <a href="/coupon/it-&-software/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">‚öôÔ∏è IT & Software</a>
                <a href="/coupon/marketing/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">üì¢ Marketing</a>
                <a href="/coupon/office-productivity/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">üìä Office</a>
                <a href="/coupon/personal-development/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">üå± Personal Dev</a>
                <a href="/coupon/photography-&-video/" class="block px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-blue-600/20 rounded-lg transition">üì∏ Photography</a>
              </div>
              <div class="mt-2 pt-2 border-t border-slate-700">
                <a href="/coupon/" class="block px-3 py-2 text-sm font-semibold text-blue-400 hover:text-blue-300 rounded-lg transition">View All Categories ‚Üí</a>
              </div>
            </div>
          </div>

          <!-- Search Bar (Desktop) -->
          <div class="hidden lg:flex flex-1 max-w-lg mx-4">
            <Search id="header" posts={allPosts} coupons={coupons} />
          </div>

          <!-- Navigation Links (Desktop) -->
          <nav class="hidden md:flex items-center gap-6">
            <a class="text-sm font-semibold text-slate-300 hover:text-blue-400 transition-colors" href="/coupon/">Coupons</a>
            <a class="text-sm font-semibold text-slate-300 hover:text-blue-400 transition-colors" href="/blog/">Reviews</a>
            <a class="text-sm font-semibold text-slate-300 hover:text-blue-400 transition-colors" href="/about/">About</a>
          </nav>

          <!-- Right: Mobile Toggle & Dark Mode -->
          <div class="flex items-center gap-3">
             <button
              class="dark-toggle px-2 py-2 rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-white"
              type="button"
              aria-label="Toggle theme"
            >
              <svg class="sun-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.536l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.606a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zm5.657-9.193a1 1 0 00-1.414 0l-.707.707A1 1 0 005.05 6.464l.707-.707a1 1 0 001.414-1.414zM5 6a1 1 0 100-2H4a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg>
              <svg class="moon-icon w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            </button>
            <button
              class="md:hidden p-2 hover:bg-slate-800 rounded-lg transition-all border border-transparent"
              aria-label="Open menu"
              onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"
            >
              <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div id="mobile-menu" class="hidden md:hidden border-t border-slate-700 bg-slate-800/95 backdrop-blur-xl">
        <nav class="flex flex-col p-4 space-y-2">
          <div class="mb-4">
             <Search id="mobile" posts={allPosts} coupons={coupons} />
          </div>
          <a href="/coupon/" class="block px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white border border-transparent hover:border-slate-700 font-medium transition-all">Free Coupons</a>
          <a href="/blog/" class="block px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white border border-transparent hover:border-slate-700 font-medium transition-all">Course Reviews</a>
          <a href="/about/" class="block px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white border border-transparent hover:border-slate-700 font-medium transition-all">About</a>
        </nav>
      </div>
    </header>

    {
      !isHomepage && !isCouponPage && (
        <nav aria-label="Breadcrumb" class="mx-auto max-w-6xl px-4 py-3 border-b border-slate-700 bg-slate-800/30">
          <ol class="flex items-center gap-2 text-sm">
            <li>
              <a href="/" class="hover:text-indigo-300 transition-colors font-medium text-white/60">
                Home
              </a>
            </li>
            {(() => {
              // Check if this is a blog post (single segment, not coupon, not blog index)
              const isBlogPost = segments.length === 1 && segments[0] !== 'coupon' && segments[0] !== 'blog';
              const isBlogIndex = segments.length === 1 && segments[0] === 'blog';

              if (isBlogIndex) {
                // For blog index: Home > Blog
                return (
                  <>
                    <li class="text-slate-500">/</li>
                    <li>
                      <span class="text-slate-100 font-medium">
                        Blog
                      </span>
                    </li>
                  </>
                );
              } else if (isBlogPost) {
                // For blog posts: Home > Blog > Title
                return (
                  <>
                    <li class="text-slate-500">/</li>
                    <li>
                      <a href="/blog/" class="font-medium transition-colors text-slate-300 hover:text-blue-400">
                        Blog
                      </a>
                    </li>
                    <li class="text-slate-500">/</li>
                    <li>
                      <span class="text-slate-100 font-medium">
                        {segments[0].replace(/-/g, " ")}
                      </span>
                    </li>
                  </>
                );
              } else {
                // For other pages: Home > Segment1 > Segment2 > etc.
                return segments.map((segment, index) => {
                  const isLastSegment = index === segments.length - 1;
                  let displayText = segment.replace(/-/g, " ");
                  let linkHref = `/${segments.slice(0, index + 1).join("/")}/`;

                  return (
                    <>
                      <li class="text-slate-500">/</li>
                      <li class="flex items-center gap-2">
                        {isLastSegment ? (
                          <span class="text-slate-100 font-medium">
                            {displayText}
                          </span>
                        ) : (
                          <>
                            <a
                              href={linkHref}
                              class="font-medium transition-colors text-slate-300 hover:text-blue-400"
                            >
                              {displayText}
                            </a>
                            <span class="text-slate-500">/</span>
                          </>
                        )}
                      </li>
                    </>
                  );
                });
              }
            })()}
          </ol>
        </nav>
      )
    }

    <main id="main" class={isHomepage ? "" : "mx-auto max-w-6xl px-4 py-12"}>
      <slot />
    </main>
    <footer class="border-t border-slate-700 bg-gradient-to-b from-slate-900 to-slate-950 text-slate-300">
      <div class="mx-auto max-w-6xl px-4 py-16">
        <!-- Footer Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10 mb-12">
          <!-- About Widget -->
          <div>
            <h3 class="text-slate-100 font-bold text-lg mb-4">CoursesWyn</h3>
            <p class="text-sm text-slate-400 mb-5 leading-relaxed">Independent Udemy course reviews and 50,000+ verified coupons to help you learn premium courses for free.</p>
            <div class="flex gap-4 text-slate-400">
              <a href="https://twitter.com/CoursesGift" class="hover:text-blue-400 transition-colors" title="Twitter" aria-label="Follow CoursesWyn on Twitter">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2s9 5 20 5a9.5 9.5 0 00-9-5.5c4.75 2.25 9-0.5 11-4.5a17.54 17.54 0 001-4c0-.27 0-.52-.05-.78A12.07 12.07 0 0023 3"/></svg>
              </a>             
              <a href="/rss.xml" class="hover:text-blue-400 transition-colors" title="RSS Feed" aria-label="Subscribe to RSS feed">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
              </a>
            </div>
            <p class="text-xs text-slate-500 mt-3">Follow our Twitter for verified coupon updates and learning resources.</p>
          </div>

          <!-- Explore Widget -->
          <div>
            <h4 class="text-slate-100 font-bold text-lg mb-5">Explore</h4>
            <ul class="space-y-3 text-sm">
              <li><a href="/coupon/" class="text-slate-400 hover:text-blue-400 transition-colors">Udemy Coupons</a></li>
              <li><a href="/blog/" class="text-slate-400 hover:text-blue-400 transition-colors">Course Reviews</a></li>
              <li><a href="/coupon/ai-courses/" class="text-slate-400 hover:text-blue-400 transition-colors">AI Courses</a></li>
              <li><a href="/coupon/python-courses/" class="text-slate-400 hover:text-blue-400 transition-colors">Python Courses</a></li>
              <li><a href="/coupon/development/web-development/" class="text-slate-400 hover:text-blue-400 transition-colors">Web Development</a></li>
            </ul>
          </div>

          <!-- Company Widget -->
          <div>
            <h4 class="text-slate-100 font-bold text-lg mb-5">Company</h4>
            <ul class="space-y-3 text-sm">
              <li><a href="/about/" class="text-slate-400 hover:text-blue-400 transition-colors">About Us</a></li>
              <li><a href="/contact-us/" class="text-slate-400 hover:text-blue-400 transition-colors">Contact</a></li>
              <li><a href="/privacy/" class="text-slate-400 hover:text-blue-400 transition-colors">Privacy Policy</a></li>
            </ul>
          </div>

          <!-- Newsletter Widget -->
          <div>
            <h4 class="text-slate-100 font-bold text-lg mb-5">Stay Updated</h4>
            <p class="text-sm text-slate-400 mb-4">Get new Udemy coupons delivered daily.</p>
            <form class="space-y-3">
              <input
                type="email"
                placeholder="your@email.com"
                class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/20 transition text-sm"
                required
              />
              <button
                type="submit"
                class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-2.5 rounded-lg transition text-sm shadow-lg hover:shadow-blue-500/30"
              >
                Subscribe
              </button>
            </form>
            <p class="text-xs text-slate-500 mt-3">We respect your privacy. Unsubscribe anytime.</p>
          </div>
        </div>

        <!-- Footer Bottom -->
        <div class="border-t border-slate-700 pt-8 mt-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <p class="text-sm text-slate-400">
              ¬© {new Date().getFullYear()} CoursesWyn. All rights reserved.
            </p>
            <p class="text-xs text-slate-500">
              Affiliate disclosure: We earn commission from qualifying purchases through Udemy links at no extra cost to you.
            </p>
          </div>
        </div>
      </div>
    </footer>
    <BackToTop />
  </body>
</html>
