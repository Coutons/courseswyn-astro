---
import "../styles/global.css";
import SpeedInsights from "@vercel/speed-insights/astro";
import Search from "../components/Search.astro";
import { fetchPosts } from "../lib/posts";

interface Props {
  title: string;
  description: string;
  canonical?: string;
  ogImage?: string;
  structuredData?: Record<string, any>;
}

const { title, description, canonical, ogImage, structuredData } = Astro.props;
const currentPath = Astro.url.pathname;
const segments = currentPath.split("/").filter(Boolean);
const isHomepage = currentPath === "/";

const metaTitle = title.includes("CoursesWyn")
  ? title
  : `${title} | CoursesWyn - Free Udemy Coupons & Reviews`;
const defaultOgImage = "https://courseswyn.com/images/og-default.svg";
const finalOgImage = ogImage || defaultOgImage;
const finalCanonical = canonical || new URL(currentPath, Astro.site).href;
const allPosts = await fetchPosts();
---

<html lang="en" class="min-h-full bg-surface text-white">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{metaTitle}</title>
    <meta name="description" content={description} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={finalOgImage} />
    <meta property="og:type" content="article" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={finalOgImage} />
    <link rel="canonical" href={finalCanonical} />
    <link rel="alternate" hreflang="en" href={finalCanonical} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script is:inline>
      if (typeof window !== "undefined" && typeof document !== "undefined") {
        const root = document.documentElement;
        const storedTheme = localStorage.getItem("courseswyn-theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const nextTheme = storedTheme ?? (prefersDark ? "dark" : "light");
        root.dataset.theme = nextTheme;
        root.classList.toggle("dark", nextTheme === "dark");
      }
    </script>
    <script is:inline>
      if (typeof window !== "undefined" && typeof document !== "undefined") {
        window.__COURSESWYN_TOGGLE__ = () => {
          const root = document.documentElement;
          const current = root.dataset.theme === "dark" ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          root.dataset.theme = next;
          root.classList.toggle("dark", next === "dark");
          localStorage.setItem("courseswyn-theme", next);
        };
      }
    </script>

    <!-- Organization Schema -->
    <script type="application/ld+json" is:inline>
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "CoursesWyn",
        "url": "https://courseswyn.com",
        "description": "2,500+ verified free Udemy coupons and independent course reviews. Save up to 95% on premium courses with our daily-updated deals and learning guides.",
        "logo": {
          "@type": "ImageObject",
          "url": "https://courseswyn.com/images/og-default.svg"
        },
        "sameAs": ["https://twitter.com/courseswyn", "https://reddit.com/r/courseswyn"]
      }
    </script>

    {
      structuredData && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(structuredData)}
        />
      )
    }

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GT-55B77QRB"
    ></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "GT-55B77QRB");

      // Scroll depth tracking
      let scrollDepthTracked = false;
      window.addEventListener("scroll", () => {
        if (
          !scrollDepthTracked &&
          window.scrollY > 0.5 * document.body.scrollHeight
        ) {
          scrollDepthTracked = true;
          gtag("event", "scroll_50", {
            event_category: "engagement",
            value: 50,
          });
        }
      });
    </script>
  </head>
  <body class="min-h-screen bg-surface text-white antialiased">
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-mint-500 text-white px-4 py-2 rounded"
      >Skip to content</a
    >
    <div
      class="absolute inset-0 -z-10 bg-grid-mesh [background-size:60px_60px]"
    >
    </div>
    <header
      class="sticky top-0 z-50 border-b border-white/5 bg-surface/80 backdrop-blur"
    >
      <div
        class="mx-auto flex max-w-6xl items-center justify-between px-4 py-4"
      >
        <a
          href="/"
          class="flex items-center gap-2 text-lg font-semibold tracking-tight"
        >
          <span
            class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-mint-500/20 text-mint-300"
          >
            CW
          </span>
          <span class="hidden sm:inline">CoursesWyn</span>
        </a>
        <div class="hidden md:block flex-1 max-w-md mx-6">
          <Search posts={allPosts} />
        </div>
        <nav class="hidden gap-8 text-sm text-white/70 md:flex items-center">
          <a class="hover:text-mint-300 transition" href="/coupon/">Free Coupons</a>
          <a class="hover:text-mint-300 transition" href="/blog/">Course Reviews</a>
          <a class="hover:text-mint-300 transition" href="/about/">About</a>
          <a class="hover:text-mint-300 transition" href="/contact-us/">Contact</a>
        </nav>

        <!-- Mobile Menu Button -->
        <button
          class="md:hidden p-2 hover:bg-white/5 rounded-lg transition"
          aria-label="Open menu"
          onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>

        <button
          class="dark-toggle"
          type="button"
          aria-label="Toggle theme"
          onclick="__COURSESWYN_TOGGLE__()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364-.707.707M6.343 17.657l-.707.707m12.728 0-.707-.707M6.343 6.343l-.707-.707M12 7a5 5 0 100 10 5 5 0 000-10z"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Mobile Menu -->
      <div id="mobile-menu" class="hidden md:hidden border-t border-white/5 bg-surface/95 backdrop-blur">
        <nav class="flex flex-col p-4 space-y-3">
          <a href="/coupon/" class="block px-4 py-2 rounded-lg hover:bg-white/5 text-white/70 hover:text-mint-300 transition">
            Free Coupons
          </a>
          <a href="/blog/" class="block px-4 py-2 rounded-lg hover:bg-white/5 text-white/70 hover:text-mint-300 transition">
            Course Reviews
          </a>
          <a href="/about/" class="block px-4 py-2 rounded-lg hover:bg-white/5 text-white/70 hover:text-mint-300 transition">
            About
          </a>
          <a href="/contact-us/" class="block px-4 py-2 rounded-lg hover:bg-white/5 text-white/70 hover:text-mint-300 transition">
            Contact
          </a>
        </nav>
      </div>
    </header>

    {
      !isHomepage && (
        <nav aria-label="Breadcrumb" class="mx-auto max-w-6xl px-4 py-4">
          <ol class="flex items-center gap-2 text-sm text-white/60">
            <li>
              <a href="/" class="hover:text-white">
                Home
              </a>
            </li>
            <li class="text-white/40">/</li>
            {segments.map((segment, index) => (
              <li class="flex items-center gap-2">
                {index === segments.length - 1 ? (
                  <span class="text-white/80 capitalize">
                    {segment.replace(/-/g, " ")}
                  </span>
                ) : (
                  <>
                    <a
                      href={`/${segments.slice(0, index + 1).join("/")}/`}
                      class="hover:text-white capitalize"
                    >
                      {segment.replace(/-/g, " ")}
                    </a>
                    <span class="text-white/40">/</span>
                  </>
                )}
              </li>
            ))}
          </ol>
        </nav>
      )
    }

    <main id="main" class="mx-auto max-w-6xl px-4 py-12">
      <slot />
    </main>
    <footer class="border-t border-white/5 bg-surface/80 text-white/70">
      <div class="mx-auto max-w-6xl px-4 py-12">
        <!-- Footer Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-12">
          <!-- About Widget -->
          <div>
            <h3 class="text-white font-semibold mb-4">CoursesWyn</h3>
            <p class="text-sm text-white/60 mb-4">Independent Udemy course reviews and verified coupons to help you learn for free.</p>
            <div class="flex gap-3 text-white/60">
              <a href="https://twitter.com/courseswyn" class="hover:text-mint-400 transition" title="Twitter">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2s9 5 20 5a9.5 9.5 0 00-9-5.5c4.75 2.25 9-0.5 11-4.5a17.54 17.54 0 001-4c0-.27 0-.52-.05-.78A12.07 12.07 0 0023 3"/></svg>
              </a>
              <a href="https://reddit.com/r/courseswyn" class="hover:text-mint-400 transition" title="Reddit">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.385 4.859-7.181 4.859-3.796 0-7.182-2.165-7.182-4.859a3.5 3.5 0 0 1 .476-1.465 1.762 1.762 0 0 0-.587-1.668c-.342-.364-.546-.849-.546-1.39 0-.955.778-1.734 1.733-1.734.959 0 1.734.779 1.734 1.734 0 .39-.126.756-.361 1.067.588-.435 1.404-.776 2.32-.776.656 0 1.275.165 1.758.477l-.061-2.869a1.25 1.25 0 0 1 1.246-1.257c.693 0 1.255.563 1.255 1.25.006.693-.56 1.255-1.253 1.26zm2.004 7.224c-.575-.431-1.331-.446-1.691-.15-.727.592-1.64.946-2.712.946-.296 0-.588-.017-.868-.052l.023.739c.0 2.367 3.536 4.286 7.857 4.286 2.777 0 5.229-1.12 6.326-2.655.4-.558 1.249-.944 2.227-.944.778 0 1.487.33 1.987.893.647.72.878 1.933.78 2.965l-.002.018c-.314.028-.65.044-.99.044-3.882 0-7.091-1.568-7.091-3.504 0-.126.009-.25.025-.37l-.006-.038.001.021c-.052-.265-.075-.535-.075-.81 0-.826.266-1.563.733-2.175zm4.032-3.208c.35-.035.671.166.85.431.275.39.508.927.508 1.549 0 1.02-.597 1.854-1.496 1.854-.8 0-1.45-.616-1.45-1.402 0-.588.27-1.09.68-1.358a1.02 1.02 0 0 1 .908-.474z"/></svg>
              </a>
              <a href="/rss.xml" class="hover:text-mint-400 transition" title="RSS Feed">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
              </a>
            </div>
          </div>

          <!-- Explore Widget -->
          <div>
            <h4 class="text-white font-semibold mb-4">Explore</h4>
            <ul class="space-y-2 text-sm">
              <li><a href="/coupon/" class="text-white/60 hover:text-mint-400 transition">Free Coupons</a></li>
              <li><a href="/blog/" class="text-white/60 hover:text-mint-400 transition">Course Reviews</a></li>
              <li><a href="/coupon/?category=ai" class="text-white/60 hover:text-mint-400 transition">AI Courses</a></li>
              <li><a href="/coupon/?category=python" class="text-white/60 hover:text-mint-400 transition">Python Courses</a></li>
              <li><a href="/coupon/?category=web" class="text-white/60 hover:text-mint-400 transition">Web Development</a></li>
            </ul>
          </div>

          <!-- Company Widget -->
          <div>
            <h4 class="text-white font-semibold mb-4">Company</h4>
            <ul class="space-y-2 text-sm">
              <li><a href="/about/" class="text-white/60 hover:text-mint-400 transition">About Us</a></li>
              <li><a href="/contact-us/" class="text-white/60 hover:text-mint-400 transition">Contact</a></li>
              <li><a href="/privacy/" class="text-white/60 hover:text-mint-400 transition">Privacy Policy</a></li>
              <li><a href="#" class="text-white/60 hover:text-mint-400 transition">Terms of Service</a></li>
              <li><a href="#" class="text-white/60 hover:text-mint-400 transition">Advertise</a></li>
            </ul>
          </div>

          <!-- Newsletter Widget -->
          <div>
            <h4 class="text-white font-semibold mb-4">Newsletter</h4>
            <p class="text-sm text-white/60 mb-4">Get new free coupons delivered to your inbox daily.</p>
            <form class="space-y-2">
              <input 
                type="email" 
                placeholder="your@email.com" 
                class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-mint-500 transition text-sm"
                required
              />
              <button 
                type="submit"
                class="w-full bg-mint-500 hover:bg-mint-600 text-black font-semibold py-2 rounded-lg transition text-sm"
              >
                Subscribe
              </button>
            </form>
            <p class="text-xs text-white/40 mt-3">We respect your privacy. Unsubscribe at any time.</p>
          </div>
        </div>

        <!-- Footer Bottom -->
        <div class="border-t border-white/10 pt-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <p class="text-sm text-white/60">
              Â© {new Date().getFullYear()} CoursesWyn. All rights reserved.
            </p>
            <p class="text-xs text-white/40">
              Affiliate disclosure: We earn commission from qualifying purchases through Udemy links at no extra cost to you.
            </p>
          </div>
        </div>
      </div>
    </footer>
    <SpeedInsights />
  </body>
</html>
