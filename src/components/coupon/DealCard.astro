---
interface DealProps {
  title: string;
  description?: string;
  image?: string;
  provider?: string;
  instructor?: string;
  category?: string;
  rating?: number;
  students?: number;
  price?: string;
  originalPrice?: string;
  discount?: string;
  url?: string;
  verified?: boolean;
  expiryDate?: string;
  slug?: string;
  language?: string;
}
const { title, description, image, provider, instructor, category, rating, students, price, originalPrice, discount, url, verified = false, expiryDate, slug, language } = Astro.props as DealProps;
const calculatedDiscount = calculateDiscount(price, originalPrice);

function getDaysUntilExpiry(expiryDate: string | undefined): number {
  if (!expiryDate) return 0;
  const today = new Date();
  const expiry = new Date(expiryDate);
  const diffTime = expiry.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays);
}

function calculateDiscount(price: string | undefined, originalPrice: string | undefined): string | undefined {
  if (!price || !originalPrice) return discount;

  const priceStr = price.toString().toLowerCase();
  if (priceStr.includes('free')) {
    return '-100%';
  }

  const p = parseFloat(price.replace(/[^\d.-]/g, ''));
  const op = parseFloat(originalPrice.replace(/[^\d.-]/g, ''));
  
  if (isNaN(p) || isNaN(op)) return discount;

  if (op > 0) {
    const discountPercent = Math.round(((op - p) / op) * 100);
    return `-${discountPercent}%`;
  }
  return '-0%';
}
---

<article class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-2xl hover:scale-105 flex flex-col cursor-pointer group h-full border border-slate-200 hover:border-indigo-400 relative">
  <!-- Corner Accent -->
  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-300"></div>
  <div class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-emerald-500/10 to-teal-500/10 rounded-full -ml-12 -mb-12"></div>

  <!-- Image Section with Overlay -->
  <a href={slug ? `/coupon/${slug}/` : '#'} class="block relative overflow-hidden group/img">
    <div class="relative w-full bg-gray-100" style="aspect-ratio: 16/9;">
      {image ? (
        <img src={image} alt={title} loading="lazy" class="w-full h-full object-cover transition-transform duration-500" />
      ) : (
        <div class="w-full h-full bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center text-gray-500 font-semibold">Course Image</div>
      )}

      <!-- Gradient Overlay -->
      <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

      <!-- Badge Container -->
      <div class="absolute top-4 right-4 flex flex-col gap-2 z-10">
        {calculatedDiscount && (
          <div class="bg-gradient-to-r from-red-500 to-red-600 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg backdrop-blur-sm">
            {calculatedDiscount}
          </div>
        )}
        {verified && (
          <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
            <span>‚úì</span> Verified Today
          </div>
        )}
      </div>

      <!-- Expiry Timer - Bottom Left -->
      {expiryDate && (
        <div class="absolute bottom-4 left-4 bg-white/95 backdrop-blur-sm text-slate-900 text-xs font-bold px-3 py-1.5 rounded-full shadow-lg">
          ‚è± {getDaysUntilExpiry(expiryDate)}d left
        </div>
      )}
    </div>
  </a>

  <!-- Content Section -->
  <div class="p-5 flex-1 flex flex-col h-72 relative z-10">
    <!-- Top Info Row -->
    <div class="flex items-center justify-between gap-2 mb-3">
      {provider && (
        <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full">
          {provider}
        </span>
      )}
      {category && (
        <span class="text-xs font-medium text-slate-600 bg-slate-200 px-2.5 py-1 rounded-full ml-auto">
          {category}
        </span>
      )}
    </div>

    <!-- Title -->
    <a href={slug ? `/coupon/${slug}/` : '#'}>
      <h3 class="text-lg font-bold text-slate-900 line-clamp-2 group-hover:text-indigo-600 transition-colors mb-2 leading-tight">
        {title}
      </h3>
    </a>

    <!-- Description with gradient text -->
    {description && (
      <p class="text-sm text-slate-600 line-clamp-2 mb-3 leading-snug">
        {description}
      </p>
    )}

    <!-- Instructor -->
    {instructor && (
      <div class="text-xs font-semibold text-pink-600 bg-pink-50 px-3 py-1 rounded-full mb-2 inline-block">
        üë®‚Äçüè´ {instructor}
      </div>
    )}

    <!-- Language -->
    {language && (
      <div class="text-xs font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full mb-3 inline-block ml-2">
        üåê {language}
      </div>
    )}

    <!-- Rating Section - Unique Style -->
    {(rating || students) && (
      <div class="flex items-center gap-2 mb-4 pb-3 border-b border-slate-200">
        {rating && (
          <div class="flex items-center gap-1.5">
            <div class="flex gap-0.5">
              {[...Array(5)].map((_, i) => (
                <span class={i < Math.floor(rating) ? 'text-yellow-400 text-sm' : 'text-slate-300 text-sm'}>
                  ‚òÖ
                </span>
              ))}
            </div>
            <span class="text-xs font-bold text-slate-800">{rating}</span>
          </div>
        )}
        {students && (
          <span class="text-xs text-slate-500 ml-auto">
            <span class="font-semibold text-slate-700">{students.toLocaleString()}</span> enrolled
          </span>
        )}
      </div>
    )}

    <!-- CTA Button - Full Width -->
    <a href={url || '#'} target="_blank" rel="nofollow noopener noreferrer" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-3 rounded-xl transition-all duration-300 transform hover:-translate-y-1 active:translate-y-0 text-center text-sm shadow-lg hover:shadow-xl relative overflow-hidden group/btn mb-3">
      <span class="relative z-10 flex items-center justify-center gap-2">
        Enroll Now
        <svg class="w-4 h-4 group-hover/btn:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </span>
    </a>

    <!-- Price Section - Simple -->
    {(price || originalPrice) && (
      <div class="text-center">
        <div class="flex items-baseline gap-2 justify-center">
          {price && (
            <span class="text-xl font-bold text-emerald-600">
              {price}
            </span>
          )}
          {originalPrice && (
            <span class="text-sm font-medium text-slate-400 line-through">
              {originalPrice}
            </span>
          )}
        </div>
        {calculatedDiscount && (
          <div class="text-xs text-center text-emerald-600 font-semibold mt-1">
            {calculatedDiscount === '-100%' ? '100% Free Course' : `${calculatedDiscount.replace('-', '')} OFF`}
          </div>
        )}
      </div>
    )}
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
<style>
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
</style>
