---
interface DealProps {
  title: string;
  description?: string;
  image?: string;
  provider?: string;
  instructor?: string;
  category?: string;
  rating?: number;
  students?: number;
  price?: string;
  originalPrice?: string;
  discount?: string;
  url?: string;
  verified?: boolean;
  expiryDate?: string;
  slug?: string;
  language?: string;
  variant?: "card" | "list";
}
const {
  title,
  description,
  image,
  provider,
  instructor,
  category,
  subcategory: subcatNew,
  subCategory: subcatOld,
  rating,
  students,
  price,
  originalPrice,
  url,
  verified = false,
  expiresAt: expNew,
  expiryDate: expOld,
  slug,
  language,
  variant = "card",
  class: className = "",
} = Astro.props as any;

const subcategory = subcatNew || subcatOld;
const expiresAt = expNew || expOld;

const calculatedDiscount = calculateDiscount(price, originalPrice);

function getDaysUntilExpiry(dateStr: string | undefined): number {
  if (!dateStr) return 0;
  const today = new Date();
  const expiry = new Date(dateStr);
  const diffTime = expiry.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays);
}

function calculateDiscount(
  pVal: string | number | undefined,
  opVal: string | number | undefined,
): string | undefined {
  if (pVal === undefined || opVal === undefined) return undefined;

  const p = typeof pVal === "string" ? parseFloat(pVal.replace(/[^\d.-]/g, "")) : pVal;
  const op = typeof opVal === "string" ? parseFloat(opVal.replace(/[^\d.-]/g, "")) : opVal;

  if (isNaN(p) || isNaN(op)) return undefined;
  
  if (p === 0 || p < 0.1 || String(pVal).toLowerCase().includes("free")) {
    return "-100%";
  }

  if (op > 0) {
    const discountPercent = Math.round(((op - p) / op) * 100);
    return `-${discountPercent}%`;
  }
  return undefined;
}

// Course Schema for SEO
const courseSchema = {
  "@context": "https://schema.org",
  "@type": "Course",
  name: title,
  description: description || title,
  provider: {
    "@type": "Organization",
    name: provider || "Udemy",
    sameAs: "https://www.udemy.com",
  },
  ...(instructor && {
    instructor: {
      "@type": "Person",
      name: instructor,
    },
  }),
  ...(rating && {
    aggregateRating: {
      "@type": "AggregateRating",
      ratingValue: rating,
      bestRating: "5",
      worstRating: "1",
      ...(students && { ratingCount: students }),
    },
  }),
  ...(price !== undefined &&
    originalPrice !== undefined && {
      offers: {
        "@type": "Offer",
        category: "EducationalOccupationalCredential",
        price: String(price).toLowerCase().includes("free") || price === 0
          ? "0"
          : String(price).replace(/[^\d.]/g, ""),
        priceCurrency: "USD",
        availability: "https://schema.org/InStock",
        priceValidUntil:
          expiresAt ||
          new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0],
      },
    }),
  ...(category && { courseCode: category }),
  ...(language && { inLanguage: language }),
};
---

<script type="application/ld+json" set:html={JSON.stringify(courseSchema)} />

<article
  class={`coupon-card relative group bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden transition-all duration-500 hover:border-primary/50 hover:shadow-[0_20px_40px_-15px_rgba(59,130,246,0.2)] flex ${variant === 'list' ? 'flex-col md:flex-row' : 'flex-col h-full'} ${className}`}
  data-title={title?.toLowerCase()}
  data-instructor={instructor?.toLowerCase()}
  data-category={category?.toLowerCase()}
  data-description={description?.toLowerCase()}
>
  <!-- Image Section -->
  <a
    href={slug ? `/coupon/${slug}/` : "#"}
    class={`block relative overflow-hidden bg-slate-950 shadow-inner ${variant === 'list' ? 'aspect-video md:aspect-[4/3] md:w-64 lg:w-72 flex-shrink-0' : 'aspect-video'}`}
  >
    {
      image ? (
        <img
          src={image}
          alt={title}
          loading="lazy"
          class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110 group-hover:brightness-110"
        />
      ) : (
        <div class="w-full h-full flex items-center justify-center text-slate-700 bg-[radial-gradient(circle_at_center,rgba(59,130,246,0.05),transparent)]">
          <span class="text-xs font-mono uppercase tracking-widest opacity-50">No Course Media</span>
        </div>
      )
    }

    <!-- Premium Badges -->
    <div class="absolute top-4 left-4 flex flex-col gap-2 pointer-events-none">
       {calculatedDiscount && (
          <div class="bg-primary text-white text-[10px] font-black px-2.5 py-1 rounded-lg uppercase shadow-2xl backdrop-blur-md border border-white/10">
            {calculatedDiscount} OFF
          </div>
       )}
       {verified && (
          <div class="bg-slate-950/80 text-emerald-400 text-[10px] font-bold px-2.5 py-1 rounded-lg uppercase shadow-2xl backdrop-blur-md border border-emerald-500/20 flex items-center gap-1">
            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> Verified
          </div>
       )}
    </div>

    {expiresAt && (
      <div class="absolute bottom-4 right-4 bg-slate-950/60 backdrop-blur-md text-slate-300 text-[9px] font-mono font-bold px-3 py-1 rounded-full border border-white/5">
        EXPIRES: {expiresAt.split('T')[0]}
      </div>
    )}
  </a>

  <!-- Content Section -->
  <div class={`p-6 flex-1 flex flex-col ${variant === 'list' ? 'md:justify-center' : ''}`}>
    <div class="flex items-center gap-2 mb-3">
       <span class="text-[10px] font-mono font-bold text-primary px-2 py-0.5 bg-primary/10 rounded-md border border-primary/20 uppercase tracking-tighter">
        {category || "Course"}
       </span>
       {subcategory && (
         <span class="text-[10px] font-mono font-bold text-slate-500 uppercase tracking-tighter">{subcategory}</span>
       )}
    </div>

    <a href={slug ? `/coupon/${slug}/` : "#"} class={`group/title block mb-2 ${variant === 'list' ? '' : 'h-12 overflow-hidden'}`}>
      <h3 class={`text-base font-black text-white leading-tight group-hover/title:text-primary transition-colors ${variant === 'list' ? 'text-lg md:text-xl' : 'line-clamp-2'}`}>
        {title}
      </h3>
    </a>

    {variant === 'list' && description && (
      <p class="text-slate-400 text-sm leading-relaxed line-clamp-2 mb-4 opacity-80 group-hover:opacity-100 transition-opacity hidden md:block">
        {description}
      </p>
    )}
    
    {variant === 'card' && description && (
      <p class="text-slate-400 text-xs leading-relaxed line-clamp-2 mb-6 opacity-80 group-hover:opacity-100 transition-opacity">
        {description}
      </p>
    )}

    <!-- Meta Info & CTA Split -->
    <div class={`flex ${variant === 'list' ? 'flex-col md:flex-row md:items-center md:justify-between border-t border-slate-800/50 pt-4 mt-2' : 'flex-col mt-auto'}`}>
      <div class={`flex items-center gap-6 mb-4 ${variant === 'list' ? 'md:mb-0' : 'justify-between py-4 border-y border-slate-800/50 mb-6'}`}>
         <div class="flex items-center gap-1.5 text-yellow-500">
            <span class="text-lg">â˜…</span>
            <span class="text-xs font-black text-white leading-none">{rating || "5.0"}</span>
         </div>
         <div class="text-[10px] font-mono text-slate-500 font-bold uppercase tracking-tight">
            {students ? (students >= 1000 ? `${Math.floor(students / 1000)}K+ ENROLLED` : `${students} ENROLLED`) : "NEW LISTING"}
         </div>
         {variant === 'list' && (
           <div class="hidden sm:flex items-center gap-2 text-slate-500 text-[10px] font-bold uppercase tracking-tight">
             <svg class="w-3.5 h-3.5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
             </svg>
             {language || "English"}
           </div>
         )}
      </div>

      <div class={`flex items-center gap-4 ${variant === 'list' ? 'flex-1 md:flex-initial' : 'justify-between pb-2 pt-2'}`}>
         <div class="flex flex-col">
            <span class="text-[10px] font-mono font-black text-slate-600 line-through leading-none mb-1">
               {originalPrice ? (String(originalPrice).startsWith('$') ? originalPrice : `$${originalPrice}`) : ""}
            </span>
            <span class={`text-white leading-none tracking-tighter uppercase font-black ${variant === 'list' ? 'text-2xl' : 'text-xl'}`}>
               {calculatedDiscount === "-100%" ? "FREE" : (price ? (String(price).startsWith('$') ? price : `$${price}`) : "FREE")}
            </span>
         </div>
         
         <a
          href={slug ? `/coupon/${slug}/` : "#"}
          class={`flex items-center justify-center bg-slate-800 hover:bg-primary text-white font-black uppercase tracking-widest transition-all shadow-xl hover:shadow-primary/30 rounded-2xl ${variant === 'list' ? 'px-8 py-3.5 text-xs flex-1 md:flex-initial' : 'w-full py-4 text-[11px]'}`}
         >
          Claim Deal
         </a>
      </div>
    </div>
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
