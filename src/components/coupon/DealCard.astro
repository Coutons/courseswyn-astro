---
interface DealProps {
  title: string;
  description?: string;
  image?: string;
  provider?: string;
  instructor?: string;
  category?: string;
  rating?: number;
  students?: number;
  price?: string;
  originalPrice?: string;
  discount?: string;
  url?: string;
  verified?: boolean;
  expiryDate?: string;
  slug?: string;
  language?: string;
}
const {
  title,
  description,
  image,
  provider,
  instructor,
  category,
  rating,
  students,
  price,
  originalPrice,
  discount,
  url,
  verified = false,
  expiryDate,
  slug,
  language,
} = Astro.props as DealProps;
const calculatedDiscount = calculateDiscount(price, originalPrice);

function getDaysUntilExpiry(expiryDate: string | undefined): number {
  if (!expiryDate) return 0;
  const today = new Date();
  const expiry = new Date(expiryDate);
  const diffTime = expiry.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays);
}

function calculateDiscount(
  price: string | undefined,
  originalPrice: string | undefined,
): string | undefined {
  if (!price || !originalPrice) return discount;

  const priceStr = price.toString().toLowerCase();
  if (priceStr.includes("free")) {
    return "-100%";
  }

  const p = parseFloat(price.replace(/[^\d.-]/g, ""));
  const op = parseFloat(originalPrice.replace(/[^\d.-]/g, ""));

  if (isNaN(p) || isNaN(op)) return discount;

  if (op > 0) {
    const discountPercent = Math.round(((op - p) / op) * 100);
    return `-${discountPercent}%`;
  }
  return "-0%";
}

// Course Schema for SEO
const courseSchema = {
  "@context": "https://schema.org",
  "@type": "Course",
  name: title,
  description: description || title,
  provider: {
    "@type": "Organization",
    name: provider || "Udemy",
    sameAs: "https://www.udemy.com",
  },
  ...(instructor && {
    instructor: {
      "@type": "Person",
      name: instructor,
    },
  }),
  ...(rating && {
    aggregateRating: {
      "@type": "AggregateRating",
      ratingValue: rating,
      bestRating: "5",
      worstRating: "1",
      ...(students && { ratingCount: students }),
    },
  }),
  ...(price &&
    originalPrice && {
      offers: {
        "@type": "Offer",
        category: "EducationalOccupationalCredential",
        price: price.toLowerCase().includes("free")
          ? "0"
          : price.replace(/[^\d.]/g, ""),
        priceCurrency: "USD",
        ...(calculatedDiscount === "-100%" && {
          availability: "https://schema.org/InStock",
        }),
        ...(originalPrice && {
          priceValidUntil:
            expiryDate ||
            new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
              .toISOString()
              .split("T")[0],
        }),
      },
    }),
  ...(category && { courseCode: category }),
  ...(language && { inLanguage: language }),
};
---

<script type="application/ld+json" set:html={JSON.stringify(courseSchema)} />

<article
  class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-2xl hover:shadow-blue-500/20 hover:scale-105 flex flex-col cursor-pointer group h-full border border-slate-700 hover:border-blue-500 relative"
>
  <!-- Corner Accent -->
  <div
    class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-indigo-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-300"
  >
  </div>
  <div
    class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-cyan-500/10 to-blue-500/10 rounded-full -ml-12 -mb-12"
  >
  </div>

  <!-- Image Section with Enhanced Overlay -->
  <a
    href={slug ? `/coupon/${slug}/` : "#"}
    class="block relative overflow-hidden group/img"
  >
    <div class="relative w-full bg-slate-900" style="aspect-ratio: 16/9;">
      {
        image ? (
          <img
            src={image}
            alt={title}
            loading="lazy"
            class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110 group-hover:brightness-125"
          />
        ) : (
          <div class="w-full h-full bg-gradient-to-br from-slate-700 via-slate-800 to-slate-900 flex items-center justify-center text-slate-400 font-semibold relative">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-indigo-500/10" />
            <span class="relative z-10">Course Image</span>
          </div>
        )
      }

      <!-- Enhanced Gradient Overlay with Animation -->
      <div
        class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500 group-hover:backdrop-blur-sm"
      >
      </div>

      <!-- Badge Container -->
      <div class="absolute top-4 right-4 flex flex-col gap-2 z-10">
        {
          calculatedDiscount && (
            <div class="bg-gradient-to-r from-red-600 to-red-700 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg backdrop-blur-sm">
              {calculatedDiscount}
            </div>
          )
        }
        {
          verified && (
            <div class="bg-gradient-to-r from-green-600 to-emerald-700 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
              <span>‚úì</span> Verified Today
            </div>
          )
        }
        {
          calculatedDiscount === "-100%" ? (
            <div class="bg-gradient-to-r from-blue-600 to-cyan-700 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
              <span>‚≠ê</span> 100% Free
            </div>
          ) : (
            calculatedDiscount && (
              <div class="bg-gradient-to-r from-yellow-600 to-orange-700 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
                <span>üèÜ</span> Best Deal
              </div>
            )
          )
        }
      </div>

      <!-- Expiry Timer - Bottom Left -->
      {
        expiryDate && (
          <div class="absolute bottom-4 left-4 bg-slate-800/95 backdrop-blur-sm text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg">
            ‚è± {getDaysUntilExpiry(expiryDate)}d left
          </div>
        )
      }
    </div>
  </a>

  <!-- Content Section -->
  <div class="p-5 flex-1 flex flex-col h-72 relative z-10">
    <!-- Top Info Row -->
    <div class="flex items-center justify-between gap-2 mb-3">
      {
        provider && (
          <span class="text-xs font-bold text-blue-400 bg-blue-500/20 border border-blue-500/30 px-3 py-1 rounded-full">
            {provider}
          </span>
        )
      }
      {
        category && (
          <span class="text-xs font-medium text-slate-400 bg-slate-700 px-2.5 py-1 rounded-full ml-auto">
            {category}
          </span>
        )
      }
    </div>

    <!-- Title -->
    <a href={slug ? `/coupon/${slug}/` : "#"}>
      <h3
        class="text-lg font-bold text-slate-100 line-clamp-2 group-hover:text-blue-400 transition-colors mb-2 leading-tight"
      >
        {title}
      </h3>
    </a>

    <!-- Description with gradient text -->
    {
      description && (
        <p class="text-sm text-slate-400 line-clamp-2 mb-3 leading-snug">
          {description}
        </p>
      )
    }

    <!-- Instructor -->
    {
      instructor && (
        <div class="text-xs font-semibold text-cyan-400 bg-cyan-500/10 border border-cyan-500/20 px-3 py-1 rounded-full mb-2 inline-block">
          üë®‚Äçüè´ {instructor}
        </div>
      )
    }

    <!-- Language -->
    {
      language && (
        <div class="text-xs font-semibold text-blue-400 bg-blue-500/10 border border-blue-500/20 px-3 py-1 rounded-full mb-3 inline-block ml-2">
          üåê {language}
        </div>
      )
    }

    <!-- Rating Section - Unique Style -->
    {
      (rating || students) && (
        <div class="flex items-center gap-2 mb-4 pb-3 border-b border-slate-700">
          {rating && (
            <div class="flex items-center gap-1.5">
              <div class="flex gap-0.5">
                {[...Array(5)].map((_, i) => (
                  <span
                    class={
                      i < Math.floor(rating)
                        ? "text-yellow-400 text-sm"
                        : "text-slate-600 text-sm"
                    }
                  >
                    ‚òÖ
                  </span>
                ))}
              </div>
              <span class="text-xs font-bold text-slate-300">{rating}</span>
            </div>
          )}
          {students && (
            <span class="text-xs text-slate-500 ml-auto">
              <span class="font-semibold text-slate-300">
                {students.toLocaleString()}
              </span>{" "}
              enrolled
            </span>
          )}
        </div>
      )
    }

    <!-- Enhanced CTA Button - Full Width -->
    <a
      href={url || "#"}
      target="_blank"
      rel="nofollow noopener noreferrer"
      class="w-full bg-gradient-to-r from-blue-600 via-blue-500 to-cyan-600 hover:from-blue-700 hover:via-blue-600 hover:to-cyan-700 text-white font-bold py-3.5 rounded-2xl transition-all duration-500 transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-blue-500/30 active:translate-y-0 text-center text-sm relative overflow-hidden group/btn mb-3 before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/20 before:to-transparent before:translate-x-[-100%] hover:before:translate-x-[100%] before:transition-transform before:duration-700"
    >
      <span class="relative z-10 flex items-center justify-center gap-2">
        {
          calculatedDiscount === "-100%" ? (
            <>üéÅ Get 100% FREE - Limited Time</>
          ) : calculatedDiscount ? (
            <>üî• Get {calculatedDiscount.replace("-", "")} OFF - Ends Soon</>
          ) : (
            <>üöÄ Get Course Now</>
          )
        }
        <svg
          class="w-4 h-4 group-hover/btn:translate-x-1 group-hover/btn:scale-110 transition-all duration-300"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
        </svg>
      </span>

      <!-- Shimmer Effect -->
      <div
        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 group-hover/btn:opacity-100 transition-opacity duration-500 transform -skew-x-12 group-hover/btn:animate-pulse"
      >
      </div>
    </a>

    <!-- Social Proof Badge -->
    {
      students && students > 1000 && (
        <div class="text-center mb-2">
          <span class="text-xs text-emerald-400 font-semibold bg-emerald-500/10 px-3 py-1 rounded-full border border-emerald-500/20">
            ‚úì{" "}
            {students >= 10000
              ? `${Math.floor(students / 1000)}K+`
              : `${students.toLocaleString()}`}{" "}
            students enrolled today
          </span>
        </div>
      )
    }

    <!-- Price Section - Simple -->
    {
      (price || originalPrice) && (
        <div class="text-center">
          <div class="flex items-baseline gap-2 justify-center">
            {price && (
              <span class="text-xl font-bold text-cyan-400">{price}</span>
            )}
            {originalPrice && (
              <span class="text-sm font-medium text-slate-600 line-through">
                {originalPrice}
              </span>
            )}
          </div>
          {calculatedDiscount && (
            <div class="text-xs text-center text-emerald-400 font-semibold mt-1">
              {calculatedDiscount === "-100%"
                ? "100% Free Course"
                : `${calculatedDiscount.replace("-", "")} OFF`}
            </div>
          )}
        </div>
      )
    }
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
