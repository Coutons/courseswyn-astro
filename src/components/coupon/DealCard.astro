---
const { 
  title, 
  slug, 
  image, 
  rating, 
  students, 
  price, 
  originalPrice, 
  discount, 
  instructor, 
  category, 
  subcategory,
  duration, 
  updatedAt,
  description,
  seoDescription,
  url,
  language = "English",
  variant = "list" 
} = Astro.props;

// Date Logic (Calculate time ago from actual updatedAt date)
function getTimeAgo(dateString: string | undefined) {
  if (!dateString) return "Newly Added";
  
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffHours / 24);
  
  if (diffDays > 0) {
    return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
  } else if (diffHours > 0) {
    return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
  } else {
    return "Just now";
  }
}

const timeAgo = getTimeAgo(updatedAt);

// Format students number
function formatStudents(num: number | string | undefined) {
  if (!num) return "0";
  const n = typeof num === 'string' ? parseInt(num) : num;
  if (n >= 1000000) return `${(n / 1000000).toFixed(1)}M`;
  if (n >= 1000) return `${(n / 1000).toFixed(1)}K`;
  return n.toString();
}

// Category Logic
const subcategorySlug = subcategory ? subcategory.toLowerCase().replace(/\s+/g, '-') : '';
const categorySlug = category ? category.toLowerCase().replace(/\s+/g, '-') : '';
const badgeLink = subcategory ? `/courses/subcategory/${subcategorySlug}` : `/courses/category/${categorySlug}`;
const categoryString = subcategory ? `${category} > ${subcategory}` : category;

const saveAmount = originalPrice && originalPrice > price ? Math.round(originalPrice - price) : 0;
const isTopRated = rating >= 4.7;
const isPopular = typeof students === 'number' && students >= 10000;
---

<article class="flex flex-col md:flex-row bg-[#1c252e] border border-[#2d3748] rounded-xl overflow-hidden hover:border-[#10b981] transition-all duration-300 group shadow-lg">
  
  <!-- Left: Image -->
  <div class="relative w-full md:w-72 h-48 md:h-auto flex-shrink-0">
    <img 
      src={image} 
      alt={title} 
      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
      loading="lazy" 
    />
    <div class="absolute inset-0 bg-gradient-to-r from-black/20 to-transparent"></div>
    
    <!-- Time Badge -->
    <div class="absolute top-3 left-3 flex flex-col gap-1.5 z-20">
      <div class="bg-black/60 backdrop-blur-md text-gray-200 text-[10px] font-medium px-2 py-1 rounded w-max border border-white/5 shadow-xl">
        {timeAgo}
      </div>
    </div>
  </div>

  <!-- Right: Content -->
  <div class="flex-1 p-5 lg:p-6 flex flex-col relative">
    
    <div class="flex justify-between items-start mb-2">
       <div class="flex-1">
          <h3 class="font-bold text-white text-lg lg:text-xl leading-snug group-hover:text-[#10b981] transition-colors pr-4 line-clamp-2">
             <a href={`/coupon/${slug}`}>
               {title}
             </a>
          </h3>
          <div class="flex items-center gap-2 mt-2 text-[11px] text-gray-400">
             <svg class="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
             </svg>
             <span class="font-medium">By <span class="text-gray-300">{instructor || "Expert Instructor"}</span></span>
             {isPopular && <span class="bg-blue-500/10 text-blue-400 text-[9px] font-bold px-1.5 py-0.5 rounded border border-blue-500/20 uppercase ml-1">Popular</span>}
          </div>
       </div>
    </div>

    <!-- Description -->
    <p class="text-gray-400 text-xs lg:text-sm leading-relaxed line-clamp-2 mb-5 opacity-90">
       {description || seoDescription || "Master this subject with professional tutorials and gain industry-ready skills through practical projects."}
    </p>

    <!-- Meta Badges Row -->
    <div class="flex flex-wrap items-center gap-2 mb-6 text-xs transform-gpu">
        <!-- Platform -->
        <span class="flex items-center gap-1.5 bg-[#1a202c] px-2.5 py-1 rounded-lg border border-[#2d3748] text-[10px] font-bold text-gray-300 uppercase tracking-wider">
           <svg class="w-3 h-3 text-blue-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
           Udemy
        </span>

        <!-- Rating -->
        <span class="flex items-center gap-1.5 bg-[#1a202c] px-2.5 py-1 rounded-lg border border-[#2d3748]">
           <span class="text-yellow-500 text-sm leading-none">â˜…</span>
           <span class="text-gray-100 font-bold">{rating || "0.0"}</span>
        </span>

        <!-- Category Link -->
        <a href={badgeLink} class="flex items-center gap-1.5 bg-[#1a202c] px-2.5 py-1 rounded-lg border border-[#2d3748] text-gray-300 hover:text-[#10b981] hover:border-[#10b981]/30 transition-all font-medium whitespace-nowrap group/cat">
           <svg class="w-3 h-3 text-gray-500 group-hover/cat:text-[#10b981]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
           {categoryString}
        </a>

        <!-- Duration -->
        <span class="flex items-center gap-1.5 bg-[#1a202c] px-2.5 py-1 rounded-lg border border-[#2d3748] text-gray-400">
           <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
           <span class="text-gray-300">{duration || "N/A"}</span>
        </span>

        <!-- Students -->
        <span class="flex items-center gap-1.5 bg-[#1a202c] px-2.5 py-1 rounded-lg border border-[#2d3748] text-gray-400">
           <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
           <span class="text-gray-300 font-medium">{formatStudents(students)}</span>
        </span>

        <!-- Language -->
        <span class="flex items-center gap-1.5 bg-[#1a202c] px-2.5 py-1 rounded-lg border border-[#2d3748] text-gray-400">
           <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
           <span class="text-gray-300">{language}</span>
        </span>
    </div>

    <!-- Bottom: Price & Button -->
    <div class="mt-auto pt-5 border-t border-[#2d3748] flex flex-col sm:flex-row justify-between items-center gap-5">
        <div class="flex flex-col sm:items-start items-center leading-none">
            <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2 sm:gap-3">
                <span class={`font-bold text-2xl ${price === 0 || price === "Free" ? 'text-[#10b981] animate-pulse drop-shadow-[0_0_8px_rgba(16,185,129,0.3)]' : 'text-white'}`}>
                    {price === 0 || price === "Free" ? "FREE" : `$${price}`}
                </span>
                
                {originalPrice && originalPrice > price && (
                   <span class="text-gray-500 line-through text-[13px] font-medium">${originalPrice}</span>
                )}
                
                {saveAmount > 0 ? (
                    <span class="text-[10px] font-bold text-orange-400 bg-orange-400/10 px-2 py-0.5 rounded border border-orange-400/20 uppercase tracking-tight">
                        {price === 0 ? "100% OFF" : `${Math.round(((originalPrice - price) / originalPrice) * 100)}% OFF`}
                    </span>
                ) : (price === 0 || price === "Free") ? (
                    <span class="text-[10px] font-bold text-red-500 bg-red-500/10 px-2 py-0.5 rounded border border-red-500/20 uppercase tracking-tight">100% OFF</span>
                ) : null}
                
                <span class="text-[#10b981] text-[10px] font-bold flex items-center gap-1 uppercase tracking-wider sm:ml-1">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                    Verified
                </span>
            </div>
        </div>
        
        <a 
          href={url} 
          target="_blank" 
          rel="nofollow noopener"
          class="w-full sm:w-auto min-w-[160px] px-8 py-3.5 bg-gradient-to-r from-[#059669] to-[#10b981] text-white text-sm lg:text-md font-bold rounded-xl text-center shadow-lg shadow-green-500/10 hover:shadow-green-500/25 hover:scale-[1.03] active:scale-95 transition-all flex items-center justify-center gap-2 uppercase tracking-widest group/btn"
        >
          <span>Get Coupon</span>
          <svg class="w-5 h-5 transition-transform group-hover/btn:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
          </svg>
        </a>
    </div>

  </div>
</article>

