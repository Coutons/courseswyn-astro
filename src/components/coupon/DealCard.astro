---
const {
  title,
  description,
  image,
  provider,
  instructor,
  category,
  subcategory: subcatNew,
  subCategory: subcatOld,
  rating,
  students,
  price,
  originalPrice,
  verified = false,
  expiresAt: expNew,
  expiryDate: expOld,
  slug,
  language,
  variant = "card",
  class: className = "",
} = Astro.props as any;

const subcategory = subcatNew || subcatOld;
const expiresAt = expNew || expOld;

const calculatedDiscount = calculateDiscount(price, originalPrice);

function getDaysUntilExpiry(dateStr: string | undefined): number {
  if (!dateStr) return 0;
  const today = new Date();
  const expiry = new Date(dateStr);
  const diffTime = expiry.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays);
}

function calculateDiscount(
  pVal: string | number | undefined,
  opVal: string | number | undefined,
): string | undefined {
  if (pVal === undefined || opVal === undefined) return undefined;

  const p = typeof pVal === "string" ? parseFloat(pVal.replace(/[^\d.-]/g, "")) : pVal;
  const op = typeof opVal === "string" ? parseFloat(opVal.replace(/[^\d.-]/g, "")) : opVal;

  if (isNaN(p) || isNaN(op)) return undefined;
  
  if (p === 0 || p < 0.1 || String(pVal).toLowerCase().includes("free")) {
    return "-100%";
  }

  if (op > 0) {
    const discountPercent = Math.round(((op - p) / op) * 100);
    return `-${discountPercent}%`;
  }
  return undefined;
}

// SEO-optimized Course Schema
const courseSchema = {
  "@context": "https://schema.org",
  "@type": "Course",
  name: title,
  description: description || title,
  provider: {
    "@type": "Organization",
    name: provider || "Udemy",
    sameAs: "https://www.udemy.com",
  },
  ...(instructor && {
    instructor: {
      "@type": "Person",
      name: instructor,
    },
  }),
  ...(rating && {
    aggregateRating: {
      "@type": "AggregateRating",
      ratingValue: rating,
      bestRating: "5",
      worstRating: "1",
      ...(students && { ratingCount: students }),
    },
  }),
  ...(price !== undefined &&
    originalPrice !== undefined && {
      offers: {
        "@type": "Offer",
        category: "EducationalOccupationalCredential",
        price: String(price).toLowerCase().includes("free") || price === 0
          ? "0"
          : String(price).replace(/[^\d.]/g, ""),
        priceCurrency: "USD",
        availability: "https://schema.org/InStock",
        priceValidUntil:
          expiresAt ||
          new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0],
      },
    }),
  ...(category && { courseCode: category }),
  ...(language && { inLanguage: language }),
};
---

<script is:inline type="application/ld+json" set:html={JSON.stringify(courseSchema)} />

<article
  class={`coupon-card relative group bg-card border border-border rounded-2xl overflow-hidden transition-all duration-300 hover:border-primary/40 hover:shadow-[0_8px_24px_-8px_hsl(var(--primary)_/_0.18)] flex ${variant === 'list' ? 'flex-col md:flex-row' : 'flex-col h-full'} ${variant === 'compact' ? 'max-h-64' : ''} ${className}`}
  data-title={title?.toLowerCase()}
  data-instructor={instructor?.toLowerCase()}
  data-category={category?.toLowerCase()}
  data-description={description?.toLowerCase()}
>
  <!-- Compact Image Section -->
  <a
    href={slug ? `/coupon/${slug}/` : "#"}
    class={`block relative overflow-hidden bg-background shadow-inner ${variant === 'list' ? 'aspect-video md:aspect-[4/3] md:w-48 lg:w-56 flex-shrink-0' : variant === 'compact' ? 'aspect-video h-32' : 'aspect-video h-40'}`}
  >
    {
      image ? (
        <img
          src={image}
          alt={title}
          loading="lazy"
          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 group-hover:brightness-110"
        />
      ) : (
        <div class="w-full h-full flex items-center justify-center text-muted-foreground bg-[radial-gradient(circle_at_center,hsl(var(--primary)_/_0.06),transparent)]">
          <span class="text-[10px] font-mono uppercase tracking-widest opacity-60">No Course Media</span>
        </div>
      )
    }

    <!-- SEO-optimized Badges -->
    <div class="absolute top-2 left-2 flex flex-col gap-1.5 pointer-events-none">
       {calculatedDiscount && (
          <div class="bg-primary text-white text-[9px] font-black px-2 py-0.5 rounded-md uppercase shadow-lg backdrop-blur-sm border border-white/10">
            {calculatedDiscount} OFF
          </div>
       )}
       {verified && (
          <div class="bg-card/85 text-primary text-[9px] font-bold px-2 py-0.5 rounded-md uppercase shadow-lg backdrop-blur-sm border border-primary/20 flex items-center gap-1">
            <span class="w-1 h-1 bg-primary rounded-full animate-pulse"></span> Verified
          </div>
       )}
    </div>

    {expiresAt && variant !== 'compact' && (
      <div class="absolute bottom-2 right-2 bg-background/70 backdrop-blur-sm text-muted-foreground text-[8px] font-mono font-bold px-2 py-0.5 rounded-full border border-border">
        {getDaysUntilExpiry(expiresAt) <= 3 ? 'EXPIRING SOON' : expiresAt.split('T')[0]}
      </div>
    )}
  </a>

  <!-- Optimized Content Section -->
  <div class={`p-4 flex-1 flex flex-col ${variant === 'list' ? 'md:justify-center' : ''} ${variant === 'compact' ? 'p-3' : ''}`}>
    <!-- Category Tags -->
    <div class="flex items-center gap-2 mb-2">
       <span class="text-[9px] font-mono font-bold text-primary px-1.5 py-0.5 bg-primary/10 rounded border border-primary/20 uppercase tracking-tighter">
        {category || "Course"}
       </span>
       {subcategory && variant !== 'compact' && (
         <span class="text-[9px] font-mono font-bold text-muted-foreground uppercase tracking-tighter">{subcategory}</span>
       )}
    </div>

    <!-- SEO-optimized Title -->
    <a href={slug ? `/coupon/${slug}/` : "#"} class={`group/title block mb-2 ${variant === 'list' ? '' : variant === 'compact' ? 'h-8 overflow-hidden' : 'h-10 overflow-hidden'}`}>
      <h3 class={`text-sm font-black text-foreground leading-tight group-hover/title:text-primary transition-colors ${variant === 'list' ? 'text-base md:text-lg' : variant === 'compact' ? 'text-xs line-clamp-2' : 'line-clamp-2'}`}>
        {title}
      </h3>
    </a>

    {variant === 'list' && description && (
      <p class="text-muted-foreground text-sm leading-relaxed line-clamp-2 mb-3 opacity-80 group-hover:opacity-100 transition-opacity hidden md:block">
        {description}
      </p>
    )}
    
    {variant === 'card' && description && (
      <p class="text-muted-foreground text-xs leading-relaxed line-clamp-2 mb-3 opacity-80 group-hover:opacity-100 transition-opacity">
        {description}
      </p>
    )}

    <!-- Compact Meta Info -->
    <div class={`flex items-center justify-between ${variant === 'list' ? 'flex-col md:flex-row md:items-center md:justify-between border-t border-border pt-3 mt-auto' : variant === 'compact' ? 'py-2 border-t border-border mt-auto' : 'py-3 border-t border-border mt-auto'}`}>
      <div class={`flex items-center gap-4 ${variant === 'compact' ? 'gap-3' : ''}`}>
         <div class="flex items-center gap-1 text-yellow-500">
           <span class="text-sm">â˜…</span>
           <span class="text-[10px] font-black text-foreground leading-none">{rating || "5.0"}</span>
         </div>
         <div class="text-[9px] font-mono text-muted-foreground font-bold uppercase tracking-tight">
           {students ? (students >= 1000 ? `${Math.floor(students / 1000)}k+` : `${students}`) : "NEW"}
         </div>
      </div>

      <div class={`flex items-center gap-3 ${variant === 'compact' ? 'gap-2' : ''}`}>
         <div class="flex flex-col">
            <span class="text-[9px] font-mono font-black text-muted-foreground line-through leading-none mb-0.5">
               {originalPrice ? (String(originalPrice).startsWith('$') ? originalPrice : `$${originalPrice}`) : ""}
            </span>
            <span class={`text-foreground leading-none tracking-tighter uppercase font-black ${variant === 'compact' ? 'text-sm' : 'text-base'}`}>
               {calculatedDiscount === "-100%" ? "FREE" : (price ? (String(price).startsWith('$') ? price : `$${price}`) : "FREE")}
            </span>
         </div>
         
         <a
          href={slug ? `/coupon/${slug}/` : "#"}
          class={`flex items-center justify-center bg-primary hover:bg-primary/90 text-primary-foreground font-black uppercase tracking-widest transition-all shadow-lg hover:shadow-primary/20 rounded-xl ${variant === 'list' ? 'px-6 py-2.5 text-[10px] flex-1 md:flex-initial' : variant === 'compact' ? 'px-4 py-2 text-[9px]' : 'w-full py-2.5 text-[10px]'}`}
         >
          {variant === 'compact' ? 'GET' : 'Claim Deal'}
         </a>
      </div>
    </div>
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
