---
import Fuse from "fuse.js";

const { id = "default", posts = [], coupons = [] } = Astro.props;

// Prepare coupon data for search
const couponItems = (await coupons).map((coupon: any) => ({
  ...coupon,
  data: {
    title: coupon.title,
    description: coupon.description,
    tags: [coupon.category, coupon.provider],
  },
  type: "coupon",
  slug: `coupon/${coupon.slug}`,
}));

const blogItems = (await posts).map((post: any) => ({
  ...post,
  type: "blog",
}));

const allItems = [...blogItems, ...couponItems];

const fuseOptions = {
  keys: ["data.title", "data.description", "data.tags"],
  threshold: 0.3,
  includeScore: true,
};
---

<div id={`search-container-${id}`} class="relative group">
  <div class="relative">
    <input
      type="text"
      id={`search-input-${id}`}
      placeholder="Search courses, reviews, topics..."
      class="w-full rounded-lg border border-slate-700 bg-slate-800/50 px-4 py-3 pl-11 text-sm text-slate-100 placeholder-slate-500 focus:border-blue-500 focus:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
    />
    <div
      class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"
    >
      <svg
        class="h-5 w-5 text-slate-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
  </div>
  <div
    id={`search-results-${id}`}
    class="absolute top-full left-0 right-0 mt-2 hidden rounded-lg border border-slate-700 bg-slate-900 shadow-2xl overflow-hidden z-50"
  >
    <div
      class="max-h-96 overflow-y-auto p-2 space-y-2"
      id={`results-container-${id}`}
    >
    </div>
  </div>
</div>

<script is:inline define:vars={{ allItems, fuseOptions, id }}>
  // Initialize search for this specific ID
  (function () {
    const searchInput = document.getElementById(`search-input-${id}`);
    const searchResults = document.getElementById(`search-results-${id}`);
    const resultsContainer = document.getElementById(`results-container-${id}`);

    if (!searchInput || !searchResults || !resultsContainer) return;

    // Use a unique property on window if needed, or just keep it local
    const fuse = new (window.Fuse || (window.Fuse = Fuse))(
      allItems,
      fuseOptions,
    );

    // Placeholder Animation
    const placeholders = [
      "Search courses...",
      "Python",
      "Machine Learning",
      "Angela Yu",
      "JavaScript",
      "Data Science",
    ];
    let placeholderIndex = 0;

    function rotatePlaceholder() {
      placeholderIndex = (placeholderIndex + 1) % placeholders.length;
      searchInput.setAttribute("placeholder", placeholders[placeholderIndex]);
    }

    const intervalId = setInterval(rotatePlaceholder, 3000);

    searchInput.addEventListener("input", (e) => {
      const query = e.target.value.trim();

      if (query.length < 2) {
        searchResults.classList.add("hidden");
        return;
      }

      const results = fuse.search(query);

      if (results.length === 0) {
        resultsContainer.innerHTML =
          '<p class="text-slate-400 p-3 text-center">No results found</p>';
      } else {
        resultsContainer.innerHTML = results
          .slice(0, 5)
          .map((result) => {
            const item = result.item;
            const tags = item.data.tags
              .map((tag) => {
                const label = tag
                  .replace(/-/g, " ")
                  .replace(/\b\w/g, (l) => l.toUpperCase());
                return `<span class="inline-flex items-center rounded-full bg-blue-500/10 border border-blue-500/20 px-2 py-0.5 text-[10px] text-blue-300">${label}</span>`;
              })
              .join(" ");

            return `
            <a href="/${item.slug}/" class="block rounded-lg p-3 hover:bg-slate-800/50 transition-colors">
              <h3 class="text-sm font-medium text-slate-100 line-clamp-1">${item.data.title}</h3>
              <div class="mt-1 flex flex-wrap gap-1">${tags}</div>
            </a>
          `;
          })
          .join("");
      }

      searchResults.classList.remove("hidden");
    });

    // Hide results when clicking outside
    document.addEventListener("click", (e) => {
      if (
        !searchInput.contains(e.target) &&
        !searchResults.contains(e.target)
      ) {
        searchResults.classList.add("hidden");
      }
    });

    // Cleanup interval if element is removed (though it's a static page)
    // Optional: MutationObserver or just let it run.
  })();
</script>
