---
import Fuse from "fuse.js";

const posts: any[] = (await Astro.props.posts) || [];
const coupons: any[] = (await Astro.props.coupons) || [];

// Prepare coupon data for search
const couponItems = coupons.map((coupon) => ({
  ...coupon,
  data: {
    title: coupon.title,
    description: coupon.description,
    tags: [coupon.category, coupon.provider],
  },
  type: "coupon",
  slug: `coupon/${coupon.slug}`,
}));

const blogItems = posts.map((post) => ({
  ...post,
  type: "blog",
}));

const allItems = [...blogItems, ...couponItems];

const fuseOptions = {
  keys: ["data.title", "data.description", "data.tags"],
  threshold: 0.3,
  includeScore: true,
};

const fuse = new Fuse(allItems, fuseOptions);
---

<div id="search-container" class="relative group">
  <div class="relative">
    <input
      type="text"
      id="search-input"
      placeholder="Search courses, reviews, topics..."
      class="w-full rounded-lg border border-slate-700 bg-slate-800/50 px-4 py-3 pl-11 text-sm text-slate-100 placeholder-slate-500 focus:border-blue-500 focus:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
    />
    <div
      class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"
    >
      <svg
        class="h-5 w-5 text-slate-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
  </div>
  <div
    id="search-results"
    class="absolute top-full left-0 right-0 mt-2 hidden rounded-lg border border-slate-700 bg-slate-900 shadow-2xl overflow-hidden z-50"
  >
    <div class="max-h-96 overflow-y-auto p-2 space-y-2" id="results-container">
    </div>
  </div>
</div>

<script is:inline define:vars={{ allItems, fuseOptions }}>
  window.SEARCH_POSTS = allItems;
  window.FUSE_OPTIONS = fuseOptions;
</script>

<script>
  import Fuse from "fuse.js";

  // Extend Window interface for custom properties
  declare global {
    interface Window {
      SEARCH_POSTS: any[];
      FUSE_OPTIONS: any;
      SEARCH_FUSE_OPTIONS: any;
    }
  }

  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;
  const searchResults = document.getElementById("search-results");
  const resultsContainer = document.getElementById("results-container");

  // Placeholder Animation
  const placeholders = [
    "Search courses...",
    "Python",
    "Machine Learning",
    "Angela Yu",
    "JavaScript",
    "Data Science",
  ];
  let placeholderIndex = 0;

  function rotatePlaceholder() {
    placeholderIndex = (placeholderIndex + 1) % placeholders.length;
    if (searchInput) {
      searchInput.setAttribute("placeholder", placeholders[placeholderIndex]);
    }
  }

  setInterval(rotatePlaceholder, 3000);

  // Search Functionality
  // Wait for window variables if necessary, though inline script runs first
  const posts = window.SEARCH_POSTS;
  const fuseOptions = window.SEARCH_FUSE_OPTIONS || window.FUSE_OPTIONS;

  if (
    posts &&
    fuseOptions &&
    searchInput &&
    searchResults &&
    resultsContainer
  ) {
    const fuse = new Fuse(posts, fuseOptions);

    searchInput.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement;
      const query = target.value.trim();

      if (query.length < 2) {
        searchResults.classList.add("hidden");
        return;
      }

      const results = fuse.search(query);

      if (results.length === 0) {
        resultsContainer.innerHTML =
          '<p class="text-slate-400">No results found</p>';
      } else {
        resultsContainer.innerHTML = results
          .slice(0, 5)
          .map((result: any) => {
            const post = result.item;
            const tags = post.data.tags
              .map((tag: string) => {
                const label = tag
                  .replace(/-/g, " ")
                  .replace(/\b\w/g, (l) => l.toUpperCase());
                return `<span class="tag-pill">${label}</span>`;
              })
              .join(" ");

            return `
            <a href="/${post.slug}/" class="block rounded-lg p-3 hover:bg-slate-800/50 transition-colors">
              <h3 class="text-sm font-medium text-slate-100 line-clamp-1">${post.data.title}</h3>
              <div class="mt-1 flex flex-wrap gap-1">${tags}</div>
            </a>
          `;
          })
          .join("");
      }

      searchResults.classList.remove("hidden");
    });

    // Hide results when clicking outside
    document.addEventListener("click", (e) => {
      const target = e.target as Node;
      if (!searchInput.contains(target) && !searchResults.contains(target)) {
        searchResults.classList.add("hidden");
      }
    });
  }
</script>
