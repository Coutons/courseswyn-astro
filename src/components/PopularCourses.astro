---
import coupons from '../data/coupons.json';

// Helper function to get discount percentage
function getDiscountPercentage(price: number | string | undefined, originalPrice: number | string | undefined): string {
  const p = typeof price === "string" ? parseFloat(price.replace(/[^\d.-]/g, "")) : price || 0;
  const op = typeof originalPrice === "string" ? parseFloat(originalPrice.replace(/[^\d.-]/g, "")) : originalPrice || 0;
  
  if (p === 0 || p < 0.1 || String(price).toLowerCase().includes("free")) {
    return "100%";
  } else if (op > 0) {
    return `${Math.round(((op - p) / op) * 100)}%`;
  }
  return "0%";
}

// Sort by multiple criteria: students (as proxy for popularity), rating, newest
function getPopularCourses() {
  return coupons
    .filter(coupon => (coupon.rating as any) && (coupon.rating as any) >= 4.0) // Only high-rated courses
    .sort((a, b) => {
      // Primary sort: students (descending as proxy for popularity)
      const studentsDiff = ((b as any).students || 0) - ((a as any).students || 0);
      if (studentsDiff !== 0) return studentsDiff;
      
      // Secondary sort: rating (descending)
      const ratingDiff = ((b as any).rating || 0) - ((a as any).rating || 0);
      if (ratingDiff !== 0) return ratingDiff;
      
      // Tertiary sort: newest first
      return new Date(b.createdAt as string).getTime() - new Date(a.createdAt as string).getTime();
    })
    .slice(0, 8); // Top 8 popular courses (2x4 grid)
}

const popularCourses = getPopularCourses();

// Structured data for popular courses
const popularCoursesSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Most Popular Udemy Courses",
  description: "Top-rated and most popular Udemy courses with verified free coupons. Sorted by student engagement and ratings.",
  numberOfItems: popularCourses.length,
  itemListElement: popularCourses.map((course, index) => ({
    "@type": "Course",
    position: index + 1,
    name: course.title,
    description: course.description,
    provider: {
      "@type": "Organization",
      name: course.provider
    },
    aggregateRating: (course as any).rating ? {
      "@type": "AggregateRating",
      ratingValue: (course as any).rating,
      ratingCount: (course as any).reviewCount || 0
    } : undefined,
    offers: {
      "@type": "Offer",
      price: course.price === 0 ? "Free" : `$${course.price}`,
      priceCurrency: "USD",
      availability: "https://schema.org/InStock",
      validFrom: course.createdAt,
      url: `https://courseswyn.com/coupon/${course.slug}`
    }
  }))
};
---

<!-- Popular Courses Section - Compact -->
<section id="popular" class="py-12 bg-background">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Section Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h2 class="text-2xl font-bold text-foreground mb-2">
          ðŸ”¥ Popular Free Courses
        </h2>
        <p class="text-muted-foreground">
          Top-rated udemy courses with highest student enrollment and 100% off coupons
        </p>
      </div>
      <a href="/coupon/popular" class="text-primary hover:text-primary/80 text-sm font-medium">
        View All â†’
      </a>
    </div>
    
    <!-- Compact Grid - 2x4 Layout (Same as ExpiringDeals) -->
    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
      {popularCourses.map((course: any, index: number) => {
        const discount = getDiscountPercentage(course.price, course.originalPrice);
        const isFree = discount === "100%";
        
        return (
          <div class="bg-card rounded-lg border border-border overflow-hidden hover:border-primary/50 transition-all group">
            
            {/* Course Image - Same as ExpiringDeals */}
            <div class="relative h-32 overflow-hidden">
              <img 
                src={course.image} 
                alt={course.title}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                loading="lazy"
              />
              
              {/* Popularity Badge */}
              {index < 3 && (
                <div class="absolute top-2 left-2">
                  <span class={`px-2 py-1 rounded-full text-xs font-bold ${
                    index === 0 
                      ? 'bg-red-500 text-white' 
                      : index === 1 
                      ? 'bg-orange-500 text-white'
                      : 'bg-yellow-500 text-white'
                  }`}>
                    {index === 0 ? '#1' : index === 1 ? '#2' : '#3'}
                  </span>
                </div>
              )}
              
              {/* Discount Badge */}
              <div class="absolute top-2 right-2">
                <span class={`px-2 py-1 rounded-full text-xs font-bold ${
                  isFree 
                    ? 'bg-green-500 text-white' 
                    : 'bg-primary text-white'
                }`}>
                  {isFree ? 'FREE' : `${discount}% OFF`}
                </span>
              </div>
              
              {/* Rating Badge */}
              {course.rating && (
                <div class="absolute bottom-2 left-2 bg-background/90 backdrop-blur px-2 py-1 rounded-full border border-border">
                  <div class="flex items-center gap-1 text-xs">
                    <span class="text-amber-400">â˜…</span>
                    <span class="font-medium">{course.rating}</span>
                  </div>
                </div>
              )}
            </div>
            
            {/* Course Content - Same as ExpiringDeals */}
            <div class="p-4">
              <h3 class="font-semibold text-sm text-foreground mb-2 line-clamp-2 group-hover:text-primary transition-colors">
                {course.title}
              </h3>
              
              <div class="flex items-center gap-3 text-xs text-muted-foreground mb-3">
                {course.rating && (
                  <div class="flex items-center gap-1">
                    <span class="text-amber-400">â˜…</span>
                    <span>{course.rating}</span>
                  </div>
                )}
                {course.students && (
                  <span>{course.students > 1000 ? `${(course.students/1000).toFixed(1)}k` : course.students}</span>
                )}
              </div>
              
              <a 
                href={`/coupon/${course.slug}`}
                class={`w-full py-2 rounded-md text-xs font-medium transition-all text-center block ${
                  isFree 
                    ? 'bg-green-500 hover:bg-green-600 text-white' 
                    : 'bg-primary hover:bg-primary/90 text-primary-foreground'
                }`}
              >
                {isFree ? 'Get Free Access' : 'Activate Deal'}
              </a>
            </div>
          </div>
        );
      })}
    </div>
    
    <!-- Bottom CTA - Compact -->
    <div class="text-center mt-8">
      <a href="/coupon/" class="inline-flex items-center gap-2 bg-secondary hover:bg-secondary/80 text-secondary-foreground px-6 py-2 rounded-lg text-sm font-medium transition-colors">
        Browse All {coupons.length}+ Popular Courses
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
        </svg>
      </a>
    </div>
  </div>
</section>

<!-- Structured Data -->
<script is:inline type="application/ld+json" set:html={JSON.stringify(popularCoursesSchema)} />
